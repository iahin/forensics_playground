title,description,providing_technologies,category,usecase,mitre_tactics,mitre_techniques,killchain,qualified_search
Access to In-Scope Unencrypted Resources,"Unencrypted communications leaves you vulnerable to a data breach -- when users access PII data, ensure that all connections are encrypted.",['Web Proxy'],GDPR,Compliance,[],[],[],((tag=network tag=communicate) OR (index=pan_logs sourcetype=pan*traffic) OR (index=* sourcetype=opsec) OR (index=* sourcetype=cisco:asa)) app=workday* dest_port!=443 | table _time user app bytes* src_ip dest_ip dest_port
Access to In-scope Resources,Visibility into who is accessing in-scope resources is key to your GDPR efforts. Splunk allows easy analysis of that information.,['Web Proxy'],GDPR,Compliance,[],[],[],((tag=network tag=communicate) OR (index=pan_logs sourcetype=pan*traffic) OR (index=* sourcetype=opsec) OR (index=* sourcetype=cisco:asa)) app=workday* | table _time user app bytes* src_ip dest_ip
Activity from Expired User Identity - on Category,The GDPR requires that only authorized individuals access personal data. Alert when the account of a past employee is used to log into GDPR-tagged systems,"['Windows Security', 'Authentication']",GDPR,Compliance,"['Privilege Escalation', 'Persistence']",['Valid Accounts'],['Actions on Objectives'],"index=* (source=""*WinEventLog:Security"" OR sourcetype=linux_secure OR tag=authentication) user=* user!="""" action=success | lookup user_account_status.csv user | where _time > relative_time(terminationDate, ""+1d"") | lookup gdpr_system_category.csv host as dest OUTPUT category | search category=*"
Aggregate Risky Events,Detect low and slow activities and complex insider threat patterns by finding users with concentrations of risky activities.,['Ticket Management'],"Insider Threat, Account Sharing","Insider Threat, Advanced Threat Detection","['Persistence', 'Privilege Escalation', 'Lateral Movement']","['Valid Accounts', 'Remote Desktop Protocol', 'Windows Remote Management']",[],"index=risk earliest=-7d| rex field=search_name ""^(?<security_domain>[\w ]*) -"" | stats values(security_domain) as security_domain dc(security_domain) as num_security_domain values(search_name) as search_name dc(search_name) as num_search_name by risk_object _time | where num_security_domain >= 3 OR num_search_name >= 5"
Authentication Against a New Domain Controller,A common indicator for lateral movement is when a user starts logging into new domain controllers.,['Windows Security'],Lateral Movement,Advanced Threat Detection,['Lateral Movement'],['Remote Services'],['Installation'],"source=""*WinEventLog:Security"" index=* 4776 EventCode=4776 | rename ComputerName as DomainControllerName | table _time DomainControllerName user| stats earliest(_time) as earliest latest(_time) as latest  by user, anonymized_DomainControllerName | where earliest > relative_time(now(), ""-1d@d"") "
Basic Brute Force Detection,"Uses a simple threshold for Windows Security Logs to alert if there are a large number of failed logins, and at least one successful login from the same source.","['Authentication', 'Windows Security']","Account Compromise, Scanning",Security Monitoring,['Credential Access'],['Brute Force'],[],"index=* (source=""*WinEventLog:Security"" OR sourcetype=linux_secure OR tag=authentication) user!=""""  | stats count(eval(action=""success"")) as successes count(eval(action=""failure"")) as failures by src | where successes>0 AND failures>100"
Basic Dynamic DNS Detection,"Detect outbound communication to Dynamic DNS servers, which are frequently leveraged for command and control by all types of attackers.","['DNS', 'Web Proxy']",Command and Control,"Security Monitoring, Advanced Threat Detection","['Command and Control', 'Establish & Maintain Infrastructure', 'Adversary OPSEC']","['Dynamic DNS', 'Dynamic DNS', 'Application Layer Protocol']",['Command and Control'],"index=* sourcetype=pan:threat OR (tag=web tag=proxy) earliest=-20m@m earliest=-5m@m | eval list=""mozilla"" | `ut_parse_extended(url,list)`| lookup dynamic_dns_lookup domain as ut_domain OUTPUT inlist| search inlist=true | table _time ut_domain inlist bytes* uri"
Basic Malware Outbreak,Looks for the same malware occurring on multiple systems in a short period of time.,['Anti-Virus or Anti-Malware'],Endpoint Compromise,Security Monitoring,"['Initial Access', 'Execution', 'Privilege Escalation']","['Drive-by Compromise', 'Spearphishing Attachment', 'Spearphishing Link', 'User Execution', 'Exploitation for Privilege Escalation']",['Delivery'],index=* sourcetype=symantec:*  earliest=-24h| transaction maxpause=1d Risk_Name | where mvcount(Computer_Name)>3
Basic Malware Outbreak,Looks for the same malware occurring on multiple systems in a short period of time.,['Anti-Virus or Anti-Malware'],Endpoint Compromise,Security Monitoring,"['Initial Access', 'Execution', 'Privilege Escalation']","['Drive-by Compromise', 'Spearphishing Attachment', 'Spearphishing Link', 'User Execution', 'Exploitation for Privilege Escalation']",['Delivery'],index=* sourcetype=symantec:*  earliest=-24h| transaction maxpause=1d Risk_Name | where mvcount(Computer_Name)>3
Basic Scanning,"Looks for hosts that reach out to more than 500 hosts, or more than 500 ports in a short period of time, indicating scanning.",['Network Communication'],Scanning,Security Monitoring,['Discovery'],"['Network Service Scanning', 'Remote System Discovery']",['Reconnaissance'],index=* ( (tag=network tag=communicate) OR sourcetype=pan*traffic OR sourcetype=opsec OR sourcetype=cisco:asa) earliest=-1h | stats dc(dest_port) as num_dest_port dc(dest_ip) as num_dest_ip by src_ip | where num_dest_port > 1000 OR num_dest_ip > 1000
Basic Scanning,"Looks for hosts that reach out to more than 500 hosts, or more than 500 ports in a short period of time, indicating scanning.",['Network Communication'],Scanning,Security Monitoring,['Discovery'],"['Network Service Scanning', 'Remote System Discovery']",['Reconnaissance'],index=* ( (tag=network tag=communicate) OR sourcetype=pan*traffic OR sourcetype=opsec OR sourcetype=cisco:asa) earliest=-1h | stats dc(dest_port) as num_dest_port dc(dest_ip) as num_dest_ip by src_ip | where num_dest_port > 1000 OR num_dest_ip > 1000
Basic TOR Traffic Detection,"The anonymity of TOR makes it the perfect place to hide C&C, exfiltration, or ransomware payment via bitcoin. This example looks for ransomware activity based on FW logs.",['Network Communication'],"Command and Control, Endpoint Compromise, Ransomware",Advanced Threat Detection,"['Exfiltration', 'Command and Control']","['Exfiltration Over C2 Channel', 'Exfiltration Over Alternative Protocol', 'Application Layer Protocol', 'Non-Application Layer Protocol', 'Multi-hop Proxy']",['Command and Control'],index=* ((tag=network tag=communicate) OR (sourcetype=pan*traffic OR sourcetype=opsec OR sourcetype=cisco:asa OR sourcetype=stream*)) app=tor src_ip=* | table _time src_ip src_port dest_ip dest_port bytes app
Brute Force Access Behavior Detected - Against Category,Monitor your security controls and prove your GDPR compliance by detecting brute force (or password guessing) attacks on GDPR-tagged systems.,"['Windows Security', 'Authentication']",GDPR,Compliance,"['Credential Access', 'Privilege Escalation']","['Brute Force', 'Valid Accounts']",[],"index=* (source=""*WinEventLog:Security"" OR sourcetype=linux_secure OR tag=authentication) user=* user!=""""  | stats count(eval(action=""success"")) as successes count(eval(action=""failure"")) as failures by src dest | where successes>0 AND failures>100  | lookup gdpr_system_category host as dest| search category=* "
Brute Force Access Behavior Detected Over One Day - Against Category,Monitor your security controls and prove your GDPR compliance by detecting slow and low brute force (or password guessing) attacks on GDPR-tagged systems that occur gradually over the day.,"['Windows Security', 'Authentication']",GDPR,Compliance,"['Credential Access', 'Privilege Escalation']","['Brute Force', 'Valid Accounts']",[],"index=* (source=""*WinEventLog:Security"" OR sourcetype=linux_secure OR tag=authentication) user=* user!=""""  | stats count(eval(action=""success"")) as successes count(eval(action=""failure"")) as failures by src dest  | where successes>0 AND failures>100  | lookup gdpr_system_category host as dest | search category=* "
Building a Departmental Peer Group,Build a departmental peer group that can be used by the detections in Splunk Security Essentials.,['Windows Security'],"Insider Threat, Compliance","Compliance, Insider Threat",[],[],[],"| ldapsearch domain=splunk.local search=""(&(objectclass=user)(!(objectClass=computer))(department=*))"" attrs=""sAMAccountName,department""| rename sAMAccountName as user | table department user | eventstats values(user) as peergroup by department | eval peergroup=mvjoin(peergroup, "","")| outputlookup myPeerGroup.csv"
Cloud APIs Called More Often Than Usual Per User,"Builds a per-user baseline for how many API calls is normal, and then alerts for deviations.","['Audit Trail', 'GCP', 'Azure', 'AWS']","Account Compromise, IAM Analytics, SaaS",Advanced Threat Detection,['Technical Information Gathering'],['Determine 3rd party infrastructure services'],['Actions on Objectives'],"index=* sourcetype=aws:cloudtrail eventName=ConsoleLogin OR eventName=CreateImage OR eventName=AssociateAddress OR eventName=AttachInternetGateway OR eventName=AttachVolume OR eventName=StartInstances OR eventName=StopInstances OR eventName=UpdateService OR eventName=UpdateLoginProfile | bucket _time span=1d | stats count by user _time| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by user | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'count' > upperBound AND num_data_samples >=7"
Cloud Provisioning Activity from Unusual Country,"Looks for IaaS Provisioning activities that occur from new IPs, using GeoIP to resolve the Country.","['Audit Trail', 'GCP', 'Azure', 'AWS']","Account Compromise, IAM Analytics, Account Sharing, SaaS, Insider Threat","Advanced Threat Detection, Insider Threat","['Persistence', 'Privilege Escalation']",['Valid Accounts'],['Actions on Objectives'],"index=* sourcetype=aws:cloudtrail eventName=Create* OR eventName=Run* OR eventName=Attach* |stats count by src eventName | iplocation src| stats earliest(_time) as earliest latest(_time) as latest  by Country, sourcetype | where earliest > relative_time(now(), ""-1d@d"") "
Cloud Provisioning Activity from Unusual IP,Looks for Cloud Provisioning activities that occur from new IPs (for organizations with strict IP controls).,"['Audit Trail', 'GCP', 'Azure', 'AWS']","Account Compromise, IAM Analytics, Account Sharing, SaaS",Advanced Threat Detection,"['Persistence', 'Privilege Escalation']",['Valid Accounts'],['Actions on Objectives'],"index=* sourcetype=aws:cloudtrail eventName=Create* OR eventName=Run* OR eventName=Attach*| stats earliest(_time) as earliest latest(_time) as latest  by src_ip, eventName | where earliest > relative_time(now(), ""-1d@d"") "
Common Filename Launched from New Path,"Simpler malware will hide in plain sight with a filename like explorer.exe, running in the user profile. This detection will look for new paths, for common / expected executables. (MITRE CAR Reference)","['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,['Defense Evasion'],['Masquerading'],"['Installation', 'Actions on Objectives']","index=* source=""*WinEventLog:Security"" EventCode=4688 (svchost.exe New_Process_Name=*svchost.exe) OR (iexplore.exe New_Process_Name=*iexplore.exe) OR (cmd.exe New_Process_Name=*cmd.exe) OR (firefox.exe New_Process_Name=*firefox.exe) OR (explorer.exe New_Process_Name=*explorer.exe) | rex field=New_Process_Name ""^(?<filepath>.*?)(?<filename>[^\\\/]*)$"" | stats earliest(_time) as earliest latest(_time) as latest  by filename, filepath | where earliest > relative_time(now(), ""-1d@d"") "
Concentration of Attacker Tools by Filename,"It's uncommon to see attacker tools used in rapid succession on an endpoint. This search will identify tools by filename, and look for multiple executions. (MITRE CAR Reference)","['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,"Advanced Threat Detection, Security Monitoring","['Discovery', 'Lateral Movement', 'Execution', 'Credential Access', 'Persistence', 'Privilege Escalation', 'Exfiltration', 'Defense Evasion']","['Account Discovery', 'Permission Groups Discovery', 'Process Discovery', 'Remote System Discovery', 'Security Software Discovery', 'System Information Discovery', 'System Network Configuration Discovery', 'System Network Connections Discovery', 'Application Window Discovery', 'System Owner/User Discovery', 'System Service Discovery', 'Query Registry', 'Network Service Scanning', 'Credential Dumping', 'Windows Admin Shares', 'New Service', 'Modify Existing Service', 'Service Registry Permissions Weakness', 'Scheduled Task', 'Service Execution', 'Scheduled Transfer', 'Account Manipulation', 'Disabling Security Tools', 'Indicator Blocking', 'Command-Line Interface']",['Exploitation'],"index=* source=""*WinEventLog:Security"" EventCode=4688 [| inputlookup tools.csv WHERE discovery_or_attack=attack | stats values(filename) as search | format] | transaction host maxpause=5m | where eventcount>=4| fields - _raw closed_txn field_match_sum linecount"
Concentration of Attacker Tools by SHA1 Hash,"It's uncommon to see attacker tools used in rapid succession on an endpoint. This search will identify tools by file hash, and look for multiple executions. (MITRE CAR Reference)",['Endpoint Detection and Response'],Endpoint Compromise,"Advanced Threat Detection, Security Monitoring","['Discovery', 'Lateral Movement', 'Execution', 'Credential Access', 'Privilege Escalation', 'Persistence', 'Exfiltration', 'Defense Evasion']","['Account Discovery', 'Application Window Discovery', 'Permission Groups Discovery', 'Process Discovery', 'Query Registry', 'System Information Discovery', 'System Network Configuration Discovery', 'Security Software Discovery', 'System Service Discovery', 'System Owner/User Discovery', 'System Network Connections Discovery', 'Credential Dumping', 'Windows Admin Shares', 'New Service', 'Modify Existing Service', 'Service Registry Permissions Weakness', 'Service Execution', 'Scheduled Transfer', 'Scheduled Task', 'Disabling Security Tools', 'Account Manipulation', 'Command-Line Interface', 'Indicator Blocking']",['Exploitation'],"index=* sourcetype=""xmlwineventlog:microsoft-windows-sysmon/operational"" EventCode=1  [|inputlookup tools.csv | search discovery_or_attack=attack | stats values(hash) as search | eval search=mvjoin(search, "" OR "")] | transaction host maxpause=5m | where eventcount>=4 | fields - _raw closed_txn field_match_sum linecount"
Concentration of Discovery Tools by Filename,"It's uncommon to see many host discovery tools launched on an endpoint, except in very specific situations. This search will identify tools by filename, and look for many launches. (MITRE CAR Reference)","['Windows Security', 'Endpoint Detection and Response']","Scanning, Endpoint Compromise","Advanced Threat Detection, Security Monitoring",['Discovery'],"['Account Discovery', 'Permission Groups Discovery', 'Process Discovery', 'System Network Configuration Discovery', 'System Owner/User Discovery', 'System Information Discovery', 'System Service Discovery']",['Exploitation'],"index=* source=""*WinEventLog:Security"" EventCode=4688 [|inputlookup tools.csv | search discovery_or_attack=discovery | stats values(filename) as search | eval search=mvjoin(search, "" OR "")] | transaction host maxpause=5m | where mvcount(Image)>=6| fields - _raw closed_txn field_match_sum linecount"
Concentration of Discovery Tools by SHA1 Hash,"It's uncommon to see many discovery tools launched on an endpoint, except in specific situations. This search will identify tools by file hash, and look for several in quick succession. (MITRE CAR Reference)",['Endpoint Detection and Response'],"Scanning, Endpoint Compromise","Advanced Threat Detection, Security Monitoring",['Discovery'],"['Account Discovery', 'Permission Groups Discovery', 'System Network Configuration Discovery', 'System Information Discovery', 'System Owner/User Discovery', 'Process Discovery', 'System Service Discovery']",['Exploitation'],"index=* sourcetype=""xmlwineventlog:microsoft-windows-sysmon/operational"" EventCode=1  [|inputlookup tools.csv | search discovery_or_attack=discovery | stats values(hash) as search | eval search=mvjoin(search, "" OR "")] | transaction host maxpause=5m | where mvcount(Image)>=6 | fields - _raw closed_txn field_match_sum linecount"
Connection to New Domain,Detects when users browse to domains never before seen in your organization.,['Web Proxy'],"Command and Control, Data Exfiltration",Advanced Threat Detection,"['Exfiltration', 'Command and Control']","['Exfiltration Over Command and Control Channel', 'Exfiltration Over Alternative Protocol', 'Standard Application Layer Protocol']",['Actions on Objectives'],"tag=web url=* | eval list=""mozilla"" | `ut_parse_extended(url,list)`| regex ut_domain!=""^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$""| stats earliest(_time) as earliest latest(_time) as latest  by ut_domain, sourcetype | where earliest > relative_time(now(), ""-1d@d"") "
Credentials In File Detected,"Adversaries may dump credentials into local files using OS Credential Dumping or credentials might have been left in files by mistake. In cloud environments, authenticated user credentials are often stored in local configuration and credential files. This search looks for common credential patterns in log files in Splunk using a list of regexes in a lookup file.",['Any Splunk Logs'],"Compliance, Data Exfiltration","Security Monitoring, Compliance",['Credential Access'],"['Unsecured Credentials', 'Exploitation for Credential Access']",['Actions On Objectives'],
Detect Activity Related To Pass The Hash Attacks,This search looks for specific authentication events from the Windows Security Event logs to detect potential attempts at using the Pass-the-Hash technique.,['Windows Security'],Lateral Movement,Advanced Threat Detection,"['Defense Evasion', 'Lateral Movement']",['Use Alternate Authentication Material'],['Actions On Objectives'],
Detect Computer Changed With Anonymous Account,This search looks for Event Code 4742 (Computer Change) or EventCode 4624 (An account was successfully logged on) with an anonymous account.,['Windows Security'],Adversary Tactics,Security Monitoring,['Lateral Movement'],['Exploitation of Remote Services'],[],
Detect Excessive Account Lockouts From Endpoint,This search identifies endpoints that have caused a relatively high number of account lockouts in a short period.,['Authentication'],Account Compromise,Security Monitoring,"['Defense Evasion', 'Persistence', 'Privilege Escalation', 'Initial Access']",['Valid Accounts'],[],
Detect Excessive User Account Lockouts,This search detects user accounts that have been locked out a relatively high number of times in a short period.,['Authentication'],Account Compromise,Security Monitoring,"['Defense Evasion', 'Persistence', 'Privilege Escalation', 'Initial Access']",['Valid Accounts'],[],
Detect Journal Clearing,This use case looks for the fsutil process clearing the update sequence number (USN) change journal.,"['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,['Defense Evasion'],['Indicator Removal on Host'],['Actions on Objectives'],index=* sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=1 Image=*fsutil* CommandLine=*usn* CommandLine=*deletejournal* | table _time host Image CommandLine
Detect Large Outbound ICMP Packets,"This search looks for outbound ICMP packets with a packet size larger than 1,000 bytes. Various threat actors have been known to use ICMP as a command and control channel for their attack infrastructure. Large ICMP packets from an endpoint to a remote host may be indicative of this activity.",['Network Communication'],Adversary Tactics,Advanced Threat Detection,[],['Non-Application Layer Protocol'],['Command and Control'],
Detect Lateral Movement With WMI,This use case looks for WMI being used for lateral movement.,"['Windows Security', 'Endpoint Detection and Response']",Lateral Movement,Advanced Threat Detection,"['Lateral Movement', 'Execution']","['Remote Services', 'Windows Management Instrumentation']","['Installation', 'Actions on Objectives']","index=* sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=1 Image=*wmic* CommandLine=*node* CommandLine=""*process call create*"" | table _time host Image CommandLine"
Detect Log Clearing With wevtutil,This use case looks for the wevutil process clearing the Windows Audit Logs,"['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,['Defense Evasion'],['Indicator Removal on Host'],['Actions on Objectives'],index=* sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=1 Image=*wevtutil* CommandLine=*cl* (CommandLine=*System* OR CommandLine=*Security* OR CommandLine=*Setup* OR CommandLine=*Application*) | table _time host Image CommandLine
Detect Malicious Requests To Exploit Jboss Servers,"This search is used to detect malicious HTTP requests crafted to exploit jmx-console in JBoss servers. The malicious requests have a long URL length, as the payload is embedded in the URL.",['Network Communication'],Web Attack,Application Security,[],[],['Delivery'],
Detect Many Unauthorized Access Attempts,"Most login failures are due to failed passwords. Login failure to sensitive systems where the users simply aren't authorized, though, can indicate malicious intent. Detect that.","['Authentication', 'Windows Security']",Insider Threat,Insider Threat,['Credential Access'],['Brute Force'],[],"index=* source=""*WinEventLog:Security"" user=* EventCode=* action=failure Logon_Type=* Failure Reason Logon Type Status=0xC000015B"
Detect Mimikatz Via PowerShell And EventCode 4663,This search looks for PowerShell reading lsass memory consistent with credential dumping.,['Windows Security'],Adversary Tactics,Advanced Threat Detection,['Credential Access'],['OS Credential Dumping'],['Actions On Objectives'],
Detect Mimikatz Via Powershell And Eventcode 4703,This search looks for PowerShell requesting privileges consistent with credential dumping.,['Windows Security'],Adversary Tactics,Advanced Threat Detection,['Credential Access'],['OS Credential Dumping'],['Actions On Objectives'],
Detect New Local Admin Account,This search looks for newly created accounts that have been elevated to local administrators.,['Windows Security'],Malware,Security Monitoring,['Persistence'],['Create Account'],"['Actions On Objectives', 'Command and Control']",
Detect Outbound SMB Traffic,This search looks for outbound SMB connections made by hosts within your network to the Internet. SMB traffic is used for Windows file-sharing activity. One of the techniques often used by attackers involves retrieving the credential hash using an SMB request made to a compromised server controlled by the threat actor.,['Network Communication'],Malware,Security Monitoring,[],['Application Layer Protocol'],"['Actions On Objectives', 'Command and Control']",
Detect S3 Access From A New IP,This search looks at S3 bucket-access logs and detects new or previously unseen remote IP addresses that have successfully accessed an S3 bucket.,"['AWS', 'Audit Trail', 'Web Server']","Cloud Security, SaaS",Advanced Threat Detection,['Collection'],['Data from Cloud Storage Object'],['Actions On Objectives'],
Disabled Update Service,"Splunk can detect the status of services, allowing us to find hosts where the Windows Update service is disabled.",['Endpoint Detection and Response'],Endpoint Compromise,Security Monitoring,['Defense Evasion'],['Disabling Security Tools'],[],"index=* (sourcetype=wmi:service OR (source=winhostmon Type=Service) OR (tag=service tag=os))  (tag=update OR Name=wuauserv) StartMode!=Auto | bucket _time span=1d | stats latest(Status) as Status latest(StartMode) as StartMode by _time host Name| stats earliest(_time) as earliest latest(_time) as latest  by StartMode, host | where earliest > relative_time(now(), ""-1d@d"") "
Disabled Update Service,"Splunk can detect the status of services, allowing us to find hosts where the Windows Update service is disabled.",['Endpoint Detection and Response'],Endpoint Compromise,Security Monitoring,['Defense Evasion'],['Disabling Security Tools'],[],"index=* (sourcetype=wmi:service OR (source=winhostmon Type=Service) OR (tag=service tag=os))  (tag=update OR Name=wuauserv) StartMode!=Auto | bucket _time span=1d | stats latest(Status) as Status latest(StartMode) as StartMode by _time host Name| stats earliest(_time) as earliest latest(_time) as latest  by StartMode, host | where earliest > relative_time(now(), ""-1d@d"") "
Email Servers Sending High Volume Traffic To Hosts,This search looks for an increase of data transfers from your email server to your clients. This could be indicative of a malicious actor collecting data using your email server.,['Network Communication'],Adversary Tactics,Advanced Threat Detection,['Collection'],['Email Collection'],['Actions On Objectives'],
Emails from Outside the Organization with Company Domains,"Phishers will often try to send emails where the from address uses your organization's domain name, e.g., emailing finance from yourceo@yourcompany.com. Detect that now!",['Email'],"Endpoint Compromise, SaaS",Advanced Threat Detection,['Initial Access'],['Spearphishing Link'],['Delivery'],"index=* sourcetype=cisco:esa* OR sourcetype=MSExchange*:MessageTracking OR tag=email src_user=* src_ip=* src_user=*@mycompany.com src_ip!=10.0.0.0/8| stats earliest(_time) as earliest latest(_time) as latest  by src_ip, sourcetype | where earliest > relative_time(now(), ""-1d@d"") "
Emails with Lookalike Domains,"Emailing from a domain name that is similar to your own is a common phishing technique, such as splunk.com receiving an email from spiunk.com. This search will detect those similar domains.",['Email'],"Endpoint Compromise, SaaS",Advanced Threat Detection,['Initial Access'],['Spearphishing Link'],['Delivery'],"index=* sourcetype=cisco:esa* OR sourcetype=ms:o365:*:messagetrace OR sourcetype=MSExchange*:MessageTracking OR tag=email src_user=*| stats count by src_user | rex field=src_user ""\@(?<domain_detected>.*)"" | stats sum(count) as count by domain_detected | eval domain_detected=mvfilter(domain_detected!=""mycompany.com"" AND domain_detected!=""company.com"" AND domain_detected!=""mycompanylovestheenvironment.com"") | eval list=""mozilla"" | `ut_parse_extended(domain_detected, list)` | foreach ut_subdomain_level* [eval orig_domain=domain_detected, domain_detected=mvappend(domain_detected, '<<FIELD>>' . ""."" . ut_tld)] | fields orig_domain domain_detected ut_domain count   | eval word1=mvappend(domain_detected, ut_domain), word2 = mvappend(""mycompany.com"", ""company.com"", ""mycompanylovestheenvironment.com"") | lookup ut_levenshtein_lookup word1 word2 | eval ut_levenshtein= min(ut_levenshtein) | where ut_levenshtein < 3 | fields - domain_detected ut_domain | rename orig_domain as top_level_domain_in_incoming_email word1 as domain_names_analyzed word2 as company_domains_used count as num_occurrences ut_levenshtein as Levenshtein_Similarity_Score"
Endpoint Uncleaned Malware Detection,"Detect a system with a malware detection that was not properly cleaned, as they carry a high risk of damage or disclosure of data.",['Anti-Virus or Anti-Malware'],"GDPR, Endpoint Compromise","Security Monitoring, Compliance","['Execution', 'Initial Access']","['User Execution', 'Drive-by Compromise', 'Spearphishing Attachment', 'Spearphishing Link']",[],index=* sourcetype=symantec:ep:*:file  | where Actual_Action!=Requested_Action AND Actual_Action!=Secondary_Action  | table _time Actual_Action Requested_Action Secondary_Action Risk_Name File_Path Computer_Name
Endpoint Uncleaned Malware Detection,"Detect a system with a malware detection that was not properly cleaned, as they carry a high risk of damage or disclosure of data.",['Anti-Virus or Anti-Malware'],"GDPR, Endpoint Compromise","Security Monitoring, Compliance","['Execution', 'Initial Access']","['User Execution', 'Drive-by Compromise', 'Spearphishing Attachment', 'Spearphishing Link']",[],index=* sourcetype=symantec:ep:*:file  | where Actual_Action!=Requested_Action AND Actual_Action!=Secondary_Action  | table _time Actual_Action Requested_Action Secondary_Action Risk_Name File_Path Computer_Name
Expected Host Not Reporting - in Category,"GDPR requires an audit trail for all activities, which means we should be receiving events constantly. Find GDPR-tagged systems that are no longer reporting events but should be.",['Any Splunk Logs'],GDPR,Compliance,[],[],[],| tstats prestats=t count(host) where latest=-2h earliest=-7d index=* groupby host | tstats prestats=t append=t count where earliest=-2h index=* groupby host  | stats count(host) as historical count as current by host | where current=0 AND isnotnull(historical) AND historical>1000 | lookup gdpr_system_category host | search category=*
Extended Period Without Successful Netbackup Backups,This search returns a list of hosts that have not successfully completed a backup in over a week.,['Backup'],Compliance,Compliance,[],[],[],
Fake Windows Processes,"This example finds processes normally run from Windows\System32 or Windows\SysWOW64, running from some other location. This can indicate a malicious process trying to hide as a legitimate process.","['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,['Defense Evasion'],['Masquerading'],['Installation'],"index=* (source=""*WinEventLog:Security"" EventCode=4688 New_Process_Name!=*Windows\\System32* New_Process_Name!=*Windows\\SysWOW64*) OR (sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=1 Image!=*Windows\\System32* Image!=*Windows\\SysWOW64*) | eval process=coalesce(Image, New_Process_Name)  | rex field=process .*\\\(?<filename>\S+)\s?$ | lookup isWindowsSystemFile_lookup filename | search systemFile=true | table _time dest host user process"
Familiar Filename Launched with New Path on Host,"Processes are typically launched from the same path. When those paths change, it can be a malicious process masquerading as a valid one, to hide in task manager. (MITRE CAR Reference)","['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,['Defense Evasion'],['Masquerading'],"['Installation', 'Actions on Objectives']","index=* source=""*WinEventLog:Security"" EventCode=4688 | rex field=Image ""(?<filename>[^\\\/]*)$"" | eval day=strftime(_time, ""%d/%m/%Y"")  | eventstats dc(day) as days_of_baseline by host | where days_of_baseline>7 | fields - day | eventstats dc(Image) as NumPaths values(Image) as Paths by filename, host | where NumPaths>1| stats earliest(_time) as earliest latest(_time) as latest  by filename, Image | where earliest > relative_time(now(), ""-1d@d"") "
Find Processes with Renamed Executables,"Oftentimes, attackers will execute a temporary file, and rename it to something innocuous (e.g. svchost.exe) to maintain persistence. This search will look for renamed executables. (MITRE CAR Reference)","['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,['Defense Evasion'],['Masquerading'],"['Installation', 'Actions on Objectives']","index=* sourcetype=""xmlwineventlog:microsoft-windows-sysmon/operational"" EventCode=1 | rex field=Image ""[\\\/](?<filename>[^\\\/]*)$"" | eval filename=lower(filename)| stats dc(filename) as NumFilenames values(filename) as Filenames values(Image) as Images by sha1 | where NumFilenames>1"
Find Unusually Long CLI Commands,Oftentimes we're able to detect malware by looking for unusually long command line strings.,['Endpoint Detection and Response'],Endpoint Compromise,"Advanced Threat Detection, Security Monitoring",['Execution'],['Command-Line Interface'],"['Installation', 'Exploitation', 'Actions on Objectives']","index=* sourcetype=""xmlwineventlog:microsoft-windows-sysmon/operational"" EventCode=1  |eval cmdlen=len(CommandLine) | eventstats stdev(cmdlen) as stdev,avg(cmdlen) as avg by host| stats max(cmdlen) as maxlen, values(stdev) as stdevperhost, values(avg) as avgperhost by host,CommandLine | where maxlen>4*stdevperhost+avgperhost"
First Time Access to Jump Server for Peer Group,Detect a user who is logging into a jump server that neither they nor any of their peers have accessed before.,"['Windows Security', 'Authentication']","Lateral Movement, Insider Threat","Insider Threat, Advanced Threat Detection","['Lateral Movement', 'Initial Access']","['Valid Accounts', 'Remote Desktop Protocol']","['Installation', 'Actions on Objectives']","index=* host=jump* source=""*WinEventLog:Security"" (4624 OR 4647 OR 4648 OR 551 OR 552 OR 540 OR 528 OR 4768 OR 4769 OR 4770 OR 4771 OR 4768 OR 4774 OR 4776 OR 4778 OR 4779 OR 672 OR 673 OR 674 OR 675 OR 678 OR 680 OR 682 OR 683) (EventCode=4624 OR EventCode=4647 OR EventCode=4648 OR EventCode=551 OR EventCode=552 OR EventCode=540 OR EventCode=528 OR EventCode=4768 OR EventCode=4769 OR EventCode=4770 OR EventCode=4771 OR EventCode=4768 OR EventCode=4774 OR EventCode=4776 OR EventCode=4778 OR EventCode=4779 OR EventCode=672 OR EventCode=673 OR EventCode=674 OR EventCode=675 OR EventCode=678 OR EventCode=680 OR EventCode=682 OR EventCode=683)| stats earliest(_time) as earliest latest(_time) as latest  by user, dest | where earliest > relative_time(now(), ""-1d@d"") "
First Time Accessing an Internal Git Repository,Find users who accessed a git repository for the first time.,['Web Server'],Data Exfiltration,"Insider Threat, Advanced Threat Detection",['Collection'],['Data from Information Repositories'],['Actions on Objectives'],"index=* source=""*/atlassian-bitbucket-access.log"" | rex ""GET /projects/[^/]*/repos/(?<git_repo>[^/]*)"" | rex ""(?<git_repo>[^/]*)\.git"" | rex ""git\.[^ /]{1,}/projects/[^/]*/repos/(?<git_repo>[^/]*)"" | eval comment = ""<-- verify these regex in your env""  | search  git_repo=""*""| stats earliest(_time) as earliest latest(_time) as latest  by user, git_repo | where earliest > relative_time(now(), ""-1d@d"") "
First Time Accessing an Internal Git Repository Not Viewed by Peers,"Find users who accessed a git repository for the first time, where their peer group also hasn't accessed it before.",['Web Server'],Data Exfiltration,Insider Threat,['Collection'],['Data from Information Repositories'],['Actions on Objectives'],
First Time Logon to New Server,Find users who logged into a new server for the first time.,"['Authentication', 'Windows Security']","Lateral Movement, GDPR","Advanced Threat Detection, Compliance, Security Monitoring",['Lateral Movement'],"['Remote Services', 'Remote Desktop Protocol']","['Installation', 'Actions On Objectives']","index=* source=""*WinEventLog:Security"" (4624 OR 4647 OR 4648 OR 551 OR 552 OR 540 OR 528 OR 4768 OR 4769 OR 4770 OR 4771 OR 4768 OR 4774 OR 4776 OR 4778 OR 4779 OR 672 OR 673 OR 674 OR 675 OR 678 OR 680 OR 682 OR 683) (EventCode=4624 OR EventCode=4647 OR EventCode=4648 OR EventCode=551 OR EventCode=552 OR EventCode=540 OR EventCode=528 OR EventCode=4768 OR EventCode=4769 OR EventCode=4770 OR EventCode=4771 OR EventCode=4768 OR EventCode=4774 OR EventCode=4776 OR EventCode=4778 OR EventCode=4779 OR EventCode=672 OR EventCode=673 OR EventCode=674 OR EventCode=675 OR EventCode=678 OR EventCode=680 OR EventCode=682 OR EventCode=683)| stats earliest(_time) as earliest latest(_time) as latest  by user, dest | where earliest > relative_time(now(), ""-1d@d"") "
First Time Seen Running Windows Service,This search looks for the first and last time a Windows service is seen running in your environment. This table is then cached.,['Windows Security'],Malware,Security Monitoring,['Execution'],['System Services'],"['Installation', 'Actions On Objectives']",
First Time USB Usage,"Find systems the first time they generate Windows Event ID 20001, which for some customers occurs when a USB drive is plugged in.","['Endpoint Detection and Response', 'DLP']",Data Exfiltration,Insider Threat,"['Lateral Movement', 'Collection', 'Exfiltration']","['Replication Through Removable Media', 'Data from Removable Media', 'Exfiltration Over Physical Medium']",['Delivery'],"index=* source=""*WinEventLog:System"" 20001 EventCode=20001| stats earliest(_time) as earliest latest(_time) as latest  by host, source | where earliest > relative_time(now(), ""-1d@d"") "
Flight Risk Emailing,"This search implements several heuristics to look for indications that a user is a flight risk. While most savvy employees will use a personal email address when emailing competitors, everyone in Security has some story of employees who don't, as it will happen. Detect when it does.",['Email'],Insider Threat,Insider Threat,[],[],[],"index=* sourcetype=cisco:esa* OR sourcetype=ms:o365:*:messagetrace OR sourcetype=MSExchange*:MessageTracking OR tag=email src_user=*@mycompany.com dest_user!=*@mycompany.com | lookup LDAPSearch.csv mail as src_user OUTPUT firstname lastname | eval hasNameInAttachment=case(like(lower(file_name), ""%"" . lower(firstname) . ""%""), 1, like(lower(file_name), ""%"" . lower(lastname) . ""%""), 1,like(lower(file_name), ""%"" . lower(substr(firstname, 1, 1) . lastname) . ""%""), 1, 1=1, 0) | search hasNameInAttachment=1 OR file_name=*resume* OR (dest_user=careers@* OR dest_user=recruiting@* OR dest_user=jobs*)| bucket _time span=1d | stats list(dest_user) as recipients list(file_name) as file_names sum(hasNameInAttachment) dc(_time) as num_days by src_user | where num_days>1 OR mvcount(recipients) > 3 OR mvcount(file_names)>3"
Flight Risk Printing,"This search implements two heuristics to look for indications that a user is a flight risk. Many people will print offer letters, drafts of their resume, or related docs on the work environment (for convenience, or because they don't have a printer at home). Detect when that happens.",['User Activity Audit'],Insider Threat,Insider Threat,['Exfiltration'],['Exfiltration Over Physical Medium'],['Actions On Objectives'],"index=* sourcetype=uniflow OR (source=""*WinEventLog:System"" EventCode=307) (File_Printed=*resume* OR File_Printed=*interview* OR File_Printed=*offer*letter*) | bucket _time span=1d | stats dc(_time) as num_days list(File_Printed) by User | where num_days>1"
Flight Risk Web Browsing,This search implements several heuristics to look for indications that a user is a flight risk from Web Logs. Detect a user who may be leaving before they do.,['Web Proxy'],Insider Threat,Insider Threat,['Exfiltration'],[],[],index=pan_logs category=job-search | bucket _time span=1d | stats dc(_time) as num_days values(app) values(category) count as num_connections by user | where num_days>1
Geographically Improbable Access Detected against Category,"To ensure you have a GDPR-mandated audit trail with individual accounts for each person, detect when the same account is logged into twice in a short period of time but from locations very far away, to a GDPR-tagged system.","['Authentication', 'AWS', 'Audit Trail']",GDPR,Compliance,['Initial Access'],['Valid Accounts'],[],"index=* sourcetype=aws:cloudtrail user=* | sort 0 user, _time | streamstats window=1 current=f values(_time) as last_time values(src) as last_src by user | lookup gdpr_aws_category accountId | where isnotnull(category) AND last_src != src AND _time - last_time < 8*60*60 | iplocation last_src | rename lat as last_lat lon as last_lon | eval location = City . ""|"" . Country . ""|"" . Region| iplocation src | eval rlat1 = pi()*last_lat/180, rlat2=pi()*lat/180, rlat = pi()*(lat-last_lat)/180, rlon= pi()*(lon-last_lon)/180 | eval a = sin(rlat/2) * sin(rlat/2) + cos(rlat1) * cos(rlat2) * sin(rlon/2) * sin(rlon/2) | eval c = 2 * atan2(sqrt(a), sqrt(1-a)) | eval distance = 6371 * c, time_difference_hours = round((_time - last_time) / 3600,2), speed=round(distance/ ( time_difference_hours),2) | fields - rlat* a c | eval day=strftime(_time, ""%m/%d/%Y"")| stats values(accountId) values(awsRegion) values(eventName) values(distance) values(eval(mvappend(last_Country, Country))) as Country values(eval(mvappend(last_City, City))) as City values(eval(mvappend(last_Region, Region))) as Region  values(lat) values(lon)  values(userAgent) max(speed) as max_speed_kph min(time_difference_hours) as min_time_difference_hours by day user distance"
Geographically Improbable Access Detected for Privileged Accounts,"Detecting when the same account is logged into twice in a short period of time but from locations very far away, is key to finding account compromise or account credential sharing for your privileged accounts.","['Authentication', 'AWS', 'Audit Trail']","Insider Threat, Account Sharing",Insider Threat,"['Privilege Escalation', 'Persistence']",['Valid Accounts'],[],"index=* sourcetype=aws:cloudtrail user=* | sort 0 user, _time | streamstats window=1 current=f values(_time) as last_time values(src) as last_src by user | lookup PrivilegedRiskScores user | where risk_score>0 AND last_src != src AND _time - last_time < 8*60*60 | iplocation last_src | rename lat as last_lat lon as last_lon | eval location = City . ""|"" . Country . ""|"" . Region| iplocation src | eval rlat1 = pi()*last_lat/180, rlat2=pi()*lat/180, rlat = pi()*(lat-last_lat)/180, rlon= pi()*(lon-last_lon)/180 | eval a = sin(rlat/2) * sin(rlat/2) + cos(rlat1) * cos(rlat2) * sin(rlon/2) * sin(rlon/2) | eval c = 2 * atan2(sqrt(a), sqrt(1-a)) | eval distance = 6371 * c, time_difference_hours = round((_time - last_time) / 3600,2), speed=round(distance/ ( time_difference_hours),2) | fields - rlat* a c | eval day=strftime(_time, ""%m/%d/%Y"")| stats values(accountId) values(awsRegion) values(eventName) values(distance) values(eval(mvappend(last_Country, Country))) as Country values(eval(mvappend(last_City, City))) as City values(eval(mvappend(last_Region, Region))) as Region  values(lat) values(lon)  values(userAgent) max(speed) as max_speed_kph min(time_difference_hours) as min_time_difference_hours by day user distance"
Healthcare Worker Opening More Patient Records Than Usual,"If a healthcare worker views more patient records than normal or more than their peers, it could be a sign that their system is infected, or that they are exfiltrating patient data.",['Audit Trail'],"Data Exfiltration, Insider Threat","Insider Threat, Advanced Threat Detection, Compliance",['Collection'],"['Data from Information Repositories', 'Data from Network Shared Drive']",['Actions on Objectives'],"index=* sourcetype=Cerner | bucket_time span=1d | stats dc(""event_list.participants.person_id"") as count by prsnl_name  _time| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by prsnl_name | eval lowerBound=(avg-stdev*3), upperBound=(avg+stdev*3)| where 'count' > upperBound AND num_data_samples >=7"
Hosts Receiving High Volume Of Network Traffic From Email Server,This search looks for an increase of data transfers from your email server to your clients. This could be indicative of a malicious actor collecting data using your email server.,['Network Communication'],Adversary Tactics,Advanced Threat Detection,['Collection'],['Email Collection'],['Actions On Objectives'],
Hosts Sending To More Destinations Than Normal,"This will typically detect scanning activity, along with lateral movement activity.",['Network Communication'],"Scanning, Endpoint Compromise","Advanced Threat Detection, Security Monitoring",['Discovery'],"['Remote System Discovery', 'Network Service Scanning']",['Reconnaissance'],"(tag=network tag=communicate) OR (index=pan_logs sourcetype=pan*traffic) OR (index=* sourcetype=opsec) OR (index=* sourcetype=cisco:asa)  | bucket _time span=1d | stats dc(dest_ip) as count by src_ip, _time| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by src_ip | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'count' > upperBound AND num_data_samples >=7"
Hosts Where Security Sources Go Quiet,A frequent concern of SOCs is that their data feeds will disappear. This search will look on a host-by-host basis for when your security sources stop reporting home.,['Any Splunk Logs'],Endpoint Compromise,Advanced Threat Detection,['Defense Evasion'],['Disabling Security Tools'],['Actions On Objectives'],
Hosts with Varied and Future Timestamps,One technique for foiling correlation searches is to alter the system time. This search will detect this scenario.,['Any Splunk Logs'],Endpoint Compromise,Advanced Threat Detection,['Defense Evasion'],['Timestomp'],['Actions On Objectives'],
In-Scope Device with Outdated Anti-Malware Found,"Alerts when a GDPR-tagged system has out of date malware definitions, which would conflict with GDPR's requirement to maintain a secure environment.",['Anti-Virus or Anti-Malware'],"GDPR, Endpoint Compromise","Security Monitoring, Compliance",[],[],[]," index=* sourcetype=symantec:* |stats max(eval(if(like(Event_Description, ""%LiveUpdate session ran successfully%"") , _time, null))) as LatestUpdate max(_time) as LatestMessage max(eval(if(tag=""error"", _time, null))) as LatestError by Host_Name | where LatestUpdate < relative_time(LatestMessage, ""-3d"") OR LatestError > LatestUpdate | lookup gdpr_system_category Host_Name | search category=* | convert ctime(LatestUpdate) ctime(LatestMessage) ctime(LatestError)"
In-Scope System with Windows Update Disabled,Any GDPR-tagged systems not receiving updates could jeopardize your GDPR status due to Article 32. Detect systems where the Windows Update service is disabled.,['Patch Management'],"GDPR, Operations","Security Monitoring, Compliance",['Defense Evasion'],['Disabling Security Tools'],[],"index=* (sourcetype=wmi:service OR (source=winhostmon Type=Service) OR (tag=service tag=os))  (tag=update OR Name=wuauserv)  StartMode!=Auto  | bucket _time span=1d | stats latest(Status) as Status latest(StartMode) as StartMode by _time host Name | lookup gdpr_system_category.csv host | search category=*| stats earliest(_time) as earliest latest(_time) as latest  by StartMode, host | where earliest > relative_time(now(), ""-1d@d"") "
Increase in # of Hosts Logged into,Find users who log into more hosts than they typically do.,"['Authentication', 'Windows Security']",Lateral Movement,Advanced Threat Detection,['Lateral Movement'],['Remote Services'],"['Installation', 'Actions On Objectives']","index=* source=""*WinEventLog:Security"" (4624 OR 4647 OR 4648 OR 551 OR 552 OR 540 OR 528 OR 4768 OR 4769 OR 4770 OR 4771 OR 4768 OR 4774 OR 4776 OR 4778 OR 4779 OR 672 OR 673 OR 674 OR 675 OR 678 OR 680 OR 682 OR 683) | bucket _time span=1d | stats dc(host) as count by user _time| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by user | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'count' > upperBound AND num_data_samples >=7"
Increase in Pages Printed,Find users who printed more pages than normal.,['User Activity Audit'],Data Exfiltration,Insider Threat,['Exfiltration'],['Exfiltration Over Physical Medium'],['Actions On Objectives'],"index=*  sourcetype=uniflow OR (source=""*WinEventLog:System"" EventCode=307) | bucket _time span=1d | stats sum(Page_Count) as Pages by User _time| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'Pages',null))) as Pages avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'Pages',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'Pages',null))) as stdev by User | eval lowerBound=(avg-stdev*1), upperBound=(avg+stdev*1)| where 'Pages' > upperBound AND num_data_samples >=7"
Increase in Source Code (Git) Downloads,Find users who have downloaded more files from git than normal.,['Web Server'],Data Exfiltration,"Insider Threat, Advanced Threat Detection",['Collection'],['Data from Information Repositories'],['Actions on Objectives'],"index=* source=""*/atlassian-bitbucket-access.log"" | bucket _time span=1d | stats count by user _time | stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by user | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'count' > upperBound AND num_data_samples >=7"
Increase in Windows Privilege Escalations,"Privilege escalation (either via RunAs or Scheduled Tasks) create Windows Security EventID 4648 events. This search will baseline per (original, unprivileged) user and then track deviations.",['Windows Security'],Account Compromise,Security Monitoring,['Privilege Escalation'],"['Scheduled Task/Job', 'Access Token Manipulation']",['Installation'],"index=* source=""*WinEventLog:Security"" 4648 EventCode=4648 | search NOT Account_Name=*$ | eval Unprivileged_Account_Name=mvindex(Account_Name, 1) | bucket _time span=1d | stats count by _time Unprivileged_Account_Name| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by user | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'count' > upperBound AND num_data_samples >=7"
Instance Created by Unusual User,Detects the first time a user creates a new instance.,"['Audit Trail', 'GCP', 'Azure', 'AWS']","Account Compromise, IAM Analytics, SaaS",Advanced Threat Detection,"['Persistence', 'Privilege Escalation']",['Valid Accounts'],['Actions on Objectives'],"index=* sourcetype=aws:cloudtrail eventType=* NOT errorMessage=* eventName=RunInstances | stats earliest(_time) as earliest latest(_time) as latest  by user, eventName | where earliest > relative_time(now(), ""-1d@d"") "
Instance Modified by Unusual User,Detects the first time a user modifies an existing instance.,"['Audit Trail', 'GCP', 'Azure', 'AWS']","Account Compromise, IAM Analytics, SaaS",Advanced Threat Detection,"['Persistence', 'Privilege Escalation']",['Valid Accounts'],['Actions on Objectives'],"index=* sourcetype=aws:cloudtrail eventName=ConsoleLogin OR eventName=CreateImage OR eventName=AssociateAddress OR eventName=AttachInternetGateway OR eventName=AttachVolume OR eventName=StartInstances OR eventName=StopInstances OR eventName=UpdateService OR eventName=UpdateLoginProfile| stats earliest(_time) as earliest latest(_time) as latest  by user, eventName | where earliest > relative_time(now(), ""-1d@d"") "
Kerberoasting Spn Request With RC4 Encryption,This search detects a potential kerberoasting attack via service principal name requests,['Windows Security'],Adversary Tactics,Security Monitoring,['Credential Access'],['Steal or Forge Kerberos Tickets'],[],
Large Web Upload,"Uses a basic threshold to detect a large web upload, which could be exfiltration from malware or a malicious insider.",['Web Proxy'],Data Exfiltration,"Security Monitoring, Insider Threat",['Exfiltration'],"['Exfiltration Over C2 Channel', 'Exfiltration Over Alternative Protocol']",[],index=* sourcetype=pan:traffic OR (tag=web tag=proxy) OR (sourcetype=opsec URL Filtering) OR sourcetype=bluecoat:proxysg* OR sourcetype=websense* earliest=-10m | where bytes_out>35000000 | table _time src_ip user bytes* app uri 
Large Web Upload,"Uses a basic threshold to detect a large web upload, which could be exfiltration from malware or a malicious insider.",['Web Proxy'],Data Exfiltration,"Security Monitoring, Insider Threat",['Exfiltration'],"['Exfiltration Over C2 Channel', 'Exfiltration Over Alternative Protocol']",[],index=* sourcetype=pan:traffic OR (tag=web tag=proxy) OR (sourcetype=opsec URL Filtering) OR sourcetype=bluecoat:proxysg* OR sourcetype=websense* earliest=-10m | where bytes_out>35000000 | table _time src_ip user bytes* app uri 
Local Account Creation,Triggered when an account is created on a workstation or endpoint. This is a local Windows account when the machine is joined to a domain.,['Windows Security'],"Endpoint Compromise, Privilege Escalation",Security Monitoring,['Persistence'],['Create Account'],[],
Malicious Command Line Executions,Ransomware and other malware variants often execute long commands using command line arguments. This search performs statistical analysis of these CLI arguments to detect potentially malicious executions.,"['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,"['Execution', 'Defense Evasion']","['Command-Line Interface', 'Scripting']",['Installation'],"index=* sourcetype=""xmlwineventlog:microsoft-windows-sysmon/operational"" EventCode=1 | eval cmdlen=len(CommandLine) | eventstats stdev(cmdlen) as stdev,avg(cmdlen) as avg by host | stats max(cmdlen) as maxlen, values(stdev) as stdevperhost, values(avg) as avgperhost by host,CommandLine | where maxlen> ((10*stdevperhost) + avgperhost)"
Many USB File Copies for User,"Build a baseline of how many file copies each user does to USB media, and detect when a user copies an uncharacteristically large number of files.","['DLP', 'Endpoint Detection and Response']",Insider Threat,Insider Threat,['Exfiltration'],['Exfiltration Over Physical Medium'],['Actions on Objectives'],"index=* source=""*WinEventLog:Security"" EventCode=4663 Object_Name=* (Accesses=""WriteData *"" OR Accesses=""AppendData *"") | regex Object_Name!=""^.Device.HarddiskVolume\d*.\s*$"" | bucket _time span=1d | stats count by user _time| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by user | eval lowerBound=(avg-stdev*5), upperBound=(avg+stdev*5)| where 'count' > upperBound AND num_data_samples >=7"
Monitor AutoRun Registry Keys,Attackers often add malware to the Windows Autorun registry keys to maintain persistence. This search looks through registry data for suspicious activities.,['Endpoint Detection and Response'],Endpoint Compromise,Advanced Threat Detection,['Persistence'],['Registry Run Keys / Startup Folder'],['Installation'],"index=* source=winRegistry process_image=""*AppData\\*"" key_path=""*currentversion\\run*"" | table _time, host, process_image, key_path"
Monitor Registry Keys For Print Monitors,"This search looks for registry activity associated with modifications to the registry key HKLM\SYSTEM\CurrentControlSet\Control\Print\Monitors. In this scenario, an attacker can load an arbitrary .dll into the print-monitor registry by giving the full path name to the after.dll. The system will execute the .dll with elevated (SYSTEM) permissions and will persist after reboot.",['Windows Security'],Endpoint Compromise,Advanced Threat Detection,[],[],['Actions On Objectives'],
Monitor Successful Backups,"With good backups, a ransomware attack goes from unrecoverable losses to a manageable nuisance. This shows how you can track successful backups.",['Backup'],"Operations, GDPR, Ransomware","Security Monitoring, Compliance",[],[],[],"index=* sourcetype=""netbackup_logs"" ""Disk/Partition backup completed successfully."" | bucket _time span=1d | stats values(COMPUTERNAME) as ""Systems Backed Up"" by _time, MESSAGE"
Monitor Successful Windows Updates,Malware often uses operating system vulnerabilities to infect an endpoint or to spread. This example verifies the Windows updates for specific vulnerabilities exploited by the WannaCry ransomware.,['Patch Management'],"Operations, GDPR, Ransomware","Security Monitoring, Compliance",[],[],[],"index=* (source=""*WinEventLog:System"" OR source=""windowsUpdateLog"") (KB4012598 OR KB4012212 OR KB4012215 OR KB4012213 OR KB4012216 OR KB4012214 OR KB4012217 OR KB4012606 OR KB4013198 OR KB4013429) | stats latest(status) as lastStatus by _time, dest, signature, signature_id | search lastStatus=installed"
Monitor Unsuccessful Backups,"With good backups, a ransomware attack goes from unrecoverable losses to a manageable nuisance. This shows how you can analyze failed backups.",['Backup'],"Operations, Ransomware",Security Monitoring,[],[],[],"index=* sourcetype=""netbackup_logs"" ""An error occurred, failed to backup."" | bucket _time span=1d | stats values(COMPUTERNAME) as ""Back Up Failures"" by _time, MESSAGE "
Monitor Unsuccessful Windows Updates,Keeping current with Microsoft updates for Windows is one of the best ways to prevent malware. This example identifies hosts that have failed to implement appropriate updates.,['Patch Management'],"Operations, Ransomware",Security Monitoring,[],[],[],"index=* source=windowsUpdateLog (KB4012598 OR KB4012212 OR KB4012215 OR KB4012213 OR KB4012216 OR KB4012214 OR KB4012217 OR KB4012606 OR KB4013198 OR KB4013429) | stats latest(status) as lastStatus by _time, dest, signature, signature_id | search lastStatus=failure"
Multiple Infections on Host,Finds hosts that have logged multiple different infections in a short period of time.,['Anti-Virus or Anti-Malware'],Endpoint Compromise,Security Monitoring,"['Initial Access', 'Execution']","['Drive-by Compromise', 'Spearphishing Attachment', 'Spearphishing Link', 'User Execution']",['Delivery'],"index=* sourcetype=symantec:* earliest=-24h | transaction maxpause=1h Computer_Name | where eventcount >=3 AND duration>240 | table _time Occurrences, signature, Requested_Action, Actual_Action, Secondary_Action, ApplicationHash, HashType, dest, src, user, Confidence, Disposition, file_path, Prevalence"
Multiple Infections on Host,Finds hosts that have logged multiple different infections in a short period of time.,['Anti-Virus or Anti-Malware'],Endpoint Compromise,Security Monitoring,"['Initial Access', 'Execution']","['Drive-by Compromise', 'Spearphishing Attachment', 'Spearphishing Link', 'User Execution']",['Delivery'],"index=* sourcetype=symantec:* earliest=-24h | transaction maxpause=1h Computer_Name | where eventcount >=3 AND duration>240 | table _time Occurrences, signature, Requested_Action, Actual_Action, Secondary_Action, ApplicationHash, HashType, dest, src, user, Confidence, Disposition, file_path, Prevalence"
New AD Domain Detected,"New AD domain names in your normal domain controller logs are a symptom of many Pass the Hash tools. While some of the latest don't produce these artifacts, this remains a very valuable detection mechanism.",['Windows Security'],Lateral Movement,"Advanced Threat Detection, Compliance",['Lateral Movement'],['Pass the Hash'],['Installation'],"index=* source=""*WinEventLog:Security"" EventCode=4624 Authentication_Package=NTLM Type=Information Account_Name!=""ANONYMOUS LOGON"" Logon_Type=3 Logon_Process=""NtLmSsP"" NOT Security_ID!=""NULL SID"" Key_Length=0| stats earliest(_time) as earliest latest(_time) as latest  by Account_Domain, EventCode | where earliest > relative_time(now(), ""-1d@d"") "
New Application Accessing Salesforce.com API,Salesforce.com contains the most critical information for many companies. This search looks for users who connect to SFDC's reporting API with new clients.,['Audit Trail'],"Data Exfiltration, GDPR, SaaS","Compliance, Insider Threat",['Collection'],['Data from Information Repositories'],['Actions on Objectives'],"index=sfdc CLIENT_NAME=* EVENT_TYPE=API OR EVENT_TYPE=BulkAPI OR EVENT_TYPE=RestAPI | lookup SFDC_User_Lookup USER_ID| stats earliest(_time) as earliest latest(_time) as latest  by USER_NAME, CLIENT_NAME | where earliest > relative_time(now(), ""-1d@d"") "
New Cloud API Call Per Peer Group,"Looks for users that are using APIs that neither they, nor their team has ever used before.","['Audit Trail', 'GCP', 'Azure', 'AWS']","Account Compromise, IAM Analytics, Insider Threat, SaaS","Advanced Threat Detection, Insider Threat","['Persistence', 'Privilege Escalation']",['Valid Accounts'],['Actions on Objectives'],"index=* sourcetype=aws:cloudtrail eventType=* NOT errorMessage=* NOT eventName=Describe* NOT eventName=Get* NOT eventName=List*m| stats earliest(_time) as earliest latest(_time) as latest  by user, eventName | lookup $outlierPeerGroupControlToken$ user OUTPUT peergroup | makemv peergroup delim="","" | multireport [| stats values(*) as * by user  eventName  ] [| stats values(eval(if(earliest>=relative_time(now(),""-1d@d""),eventName ,null))) as peertoday values(eval(if(earliest<relative_time(now(),""-1d@d""),eventName ,null))) as peerpast by peergroup eventName ] | eval user=coalesce(user, peergroup) | fields - peergroup | stats values(*) as * by user  eventName | where isnotnull(earliest)"
New Cloud Provider for User,Detect a user who is accessing a cloud storage provider they've never used before.,['Web Proxy'],"Data Exfiltration, Insider Threat, Shadow IT","Insider Threat, Security Monitoring","['Exfiltration', 'Command and Control']","['Exfiltration Over Alternative Protocol', 'Web Service']",['Actions on Objectives'],"index=* (tag=web OR sourcetype=pan:traffic OR (sourcetype=opsec URL Filtering) OR sourcetype=bluecoat:proxysg* OR sourcetype=websense*)  bytes_out>1 app=*  | search (category=online-storage-and-backup OR category=""File Storage/Sharing"" OR category=""File Storage and Sharing"" OR category=""whatever_category_your_proxy_uses"") | stats earliest(_time) as earliest latest(_time) as latest  by user, app | where earliest > relative_time(now(), ""-1d@d"") "
New Connection to In-Scope Device,"Alert Data Protection Officers to new systems that become involved in processing GDPR-scoped data via network communication logs, so DPOs can ensure the systems are authorized and documented.",['Network Communication'],"GDPR, Operations","Security Monitoring, Compliance",[],[],[],"index=* ((tag=traffic tag=communicate) OR sourcetype=pan*traffic OR sourcetype=opsec OR sourcetype=cisco*) src_ip=* dest_ip=* | stats count min(_time) as earliest max(_time) as maxtime  by src_ip, dest_ip | lookup gdpr_system_category host as dest_ip | search category=*| where earliest>relative_time(now(), ""-1d@d"")"
New Data Exfil DLP Alerts for User,"When you first seen an alert from a user who hasn't generated DLP alerts for data exfiltration before, learn about that.",['DLP'],Insider Threat,Insider Threat,['Exfiltration'],['Exfiltration'],['Actions on Objectives'],"index=* tag=dlp tag=incident | stats earliest(_time) as earliest latest(_time) as latest  by user, signature | where earliest > relative_time(now(), ""-1d@d"") "
New High Risk Event Types for Salesforce.com User,Salesforce.com supports a variety of different event types in their event logs. This search detects users who suddenly query event types associated with data exfiltration,['Audit Trail'],"Data Exfiltration, GDPR, SaaS","Compliance, Insider Threat","['Exfiltration', 'Command and Control']","['Exfiltration', 'Web Service']",['Actions on Objectives'],"index=sfdc EVENT_TYPE=API OR EVENT_TYPE=BulkAPI OR EVENT_TYPE=RestAPI OR EVENT_TYPE=ReportExport | lookup SFDC_User_Lookup USER_ID| stats earliest(_time) as earliest latest(_time) as latest  by USER_NAME, EVENT_TYPE | where earliest > relative_time(now(), ""-1d@d"") "
New IaaS API Call Per User,Looks for users that are using IaaS APIs that they've never used before.,"['Audit Trail', 'GCP', 'Azure', 'AWS']","Account Compromise, IAM Analytics, Insider Threat, SaaS","Advanced Threat Detection, Insider Threat","['Execution', 'Credential Access', 'Collection', 'Exfiltration', 'Technical Information Gathering']",['Determine 3rd party infrastructure services'],['Actions on Objectives'],"index=* sourcetype=aws:cloudtrail eventType=* NOT errorMessage=* NOT eventName=Describe* NOT eventName=Get* NOT eventName=List*| stats earliest(_time) as earliest latest(_time) as latest  by user, eventName | where earliest > relative_time(now(), ""-1d@d"") "
New Interactive Logon from a Service Account,"In most environments, service accounts should not log on interactively. This search finds new user/host combinations for accounts starting with ""svc_.""","['Authentication', 'Windows Security']",Endpoint Compromise,Advanced Threat Detection,"['Privilege Escalation', 'Persistence', 'Lateral Movement', 'Defense Evasion']","['Valid Accounts', 'Remote Services']",['Command and Control'],"index=* source=""*WinEventLog:Security"" Logon_Type=2 OR Logon_Type=10 OR Logon_Type=11 Logon Type TaskCategory=Logon Audit Success svc user=svc_* | table _time user dest | stats earliest(_time) as earliest latest(_time) as latest  by user, Logon_Type | where earliest > relative_time(now(), ""-1d@d"") "
New Local Admin Account,"Local admin accounts are used by legitimate technicians, but they're also used by attackers. This search looks for newly created accounts that are elevated to local admins.",['Windows Security'],Endpoint Compromise,"Advanced Threat Detection, Security Monitoring, Compliance","['Defense Evasion', 'Persistence']","['Valid Accounts', 'Create Account']",['Command and Control'],"index=* source=""*WinEventLog:Security"" EventCode=4720 OR (EventCode=4732 Administrators) | transaction Security_ID maxspan=180m connected=false| search EventCode=4720 (EventCode=4732 Administrators)  | table _time EventCode Account_Name Target_Account_Name Message"
New Logon Type for User,"Windows defines several logon types (Interactive, RemoteInteractive, Network, etc.). Established users rarely generate new logon types. This search will look for that scenario. (MITRE CAR Reference)",['Windows Security'],Account Compromise,"Advanced Threat Detection, Security Monitoring, Compliance","['Privilege Escalation', 'Persistence']",['Valid Accounts'],['Installation'],"index=* source=""*WinEventLog:Security"" Logon_Type=* Logon Type TaskCategory=Logon Audit Success | table _time user Logon_Type  | stats earliest(_time) as earliest latest(_time) as latest  by user, Logon_Type | where earliest > relative_time(now(), ""-1d@d"") "
New Parent Process for cmd.exe or regedit.exe,cmd.exe and regedit.exe tend to be used in the same ways. New parent processes can be suspicious. (MITRE CAR Reference),"['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,['Execution'],['Command-Line Interface'],['Exploitation'],"index=* sourcetype=*sysmon* EventCode=1 (cmd.exe Image=*\cmd.exe) OR (regedit.exe Image=*\regedit.exe)  |table  _time host Image ProcessId ParentImage ParentProcessId sha1| stats earliest(_time) as earliest latest(_time) as latest  by Image, ParentImage | where earliest > relative_time(now(), ""-1d@d"") "
New RunAs Host / Privileged Account Combination,"Privilege escalation (either via RunAs or Scheduled Tasks) create Windows Security EventID 4648 events. This search will find new usernames / host combinations, which will track privilege escalation.",['Windows Security'],Account Compromise,Security Monitoring,['Privilege Escalation'],"['Scheduled Task/Job', 'Valid Accounts']",['Installation'],"index=* source=""*WinEventLog:Security"" EventCode=4648 | search NOT Account_Name=*$ | eval Privileged_Account_Name=mvindex(Account_Name,1) | table _time  host Privileged_Account_Name| stats earliest(_time) as earliest latest(_time) as latest  by Privileged_Account_Name, host | where earliest > relative_time(now(), ""-1d@d"") "
New Service Paths for Host,New service creations are uncommon for most hosts. This search will look for both new executables and executables running from new paths launched by services.exe.,"['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,"['Persistence', 'Defense Evasion', 'Privilege Escalation']","['Masquerading', 'New Service']","['Exploitation', 'Installation', 'Command and Control']","index=* source=""*WinEventLog:Security"" EventCode=4688 services.exe | search ParentImage=*\\services.exe |table _time user host EventCode New_Process_Name ParentImage| stats earliest(_time) as earliest latest(_time) as latest  by host, Image | where earliest > relative_time(now(), ""-1d@d"") "
New Suspicious Executable Launch for User,"Some files rarely get used by legitimate activities, such as at.exe. This search will detect those executables being launched, regardless of the circumstance. (MITRE CAR Reference)","['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,['Execution'],"['Execution', 'Command-Line Interface']",['Exploitation'],"index=* source=""*WinEventLog:Security"" EventCode=4688 [|inputlookup tools.csv | search discovery_or_attack=suspicious | stats values(filename) as search | eval search=mvjoin(search, "" OR "")] | stats earliest(_time) as earliest latest(_time) as latest  by Image, user | where earliest > relative_time(now(), ""-1d@d"") "
New Suspicious cmd.exe / regedit.exe / powershell.exe Service Launch,"Very rarely would cmd.exe, regedit.exe, or powershell.exe be launched by services.exe. This search will detect that malware persistence strategy. (MITRE CAR Reference)","['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,"['Privilege Escalation', 'Persistence']",['New Service'],['Installation'],"index=* sourcetype=*sysmon* EventCode=1 ( (cmd.exe Image=*\\cmd.exe) OR (regedit.exe Image=*\\regedit.exe) OR (powershell.exe Image=*\\powershell.exe) ) (services.exe Image=*\\system32\\services.exe)| stats earliest(_time) as earliest latest(_time) as latest  by Image, host | where earliest > relative_time(now(), ""-1d@d"") "
New Tables Queried by Salesforce.com Peer Group,Salesforce.com supports a simplified query language called SOQL. This search detects users who begin querying sensitive tables that have never been contacted by peer group.,['Audit Trail'],"Data Exfiltration, GDPR, SaaS","Compliance, Insider Threat","['Discovery', 'Collection']","['Data from Information Repositories', 'Remote System Discovery']",['Actions on Objectives'],"index=sfdc QUERY=* EVENT_TYPE=API OR EVENT_TYPE=BulkAPI OR EVENT_TYPE=RestAPI | rex field=QUERY max_match=12 ""\s(?i)from\s*(?<QUERY_TABLE>[\w_]*)"" | search QUERY_TABLE=Account* OR QUERY_TABLE=Contact* OR QUERY_TABLE=Opportunity* | lookup SFDC_User_Lookup USER_IDm| stats earliest(_time) as earliest latest(_time) as latest  by USER_NAME, QUERY_TABLE | lookup $outlierPeerGroupControlToken$ USER_NAME OUTPUT peergroup | makemv peergroup delim="","" | multireport [| stats values(*) as * by USER_NAME  QUERY_TABLE  ] [| stats values(eval(if(earliest>=relative_time(now(),""-1d@d""),QUERY_TABLE ,null))) as peertoday values(eval(if(earliest<relative_time(now(),""-1d@d""),QUERY_TABLE ,null))) as peerpast by peergroup QUERY_TABLE ] | eval user=coalesce(user, peergroup) | fields - peergroup | stats values(*) as * by USER_NAME  QUERY_TABLE | where isnotnull(earliest)"
New Tables Queried by Salesforce.com User,Salesforce.com supports a simplified query language called SOQL. This search detects users who begin querying new sensitive tables.,['Audit Trail'],"Data Exfiltration, GDPR, SaaS","Compliance, Insider Threat","['Discovery', 'Collection']","['Data from Information Repositories', 'Remote System Discovery']",['Actions on Objectives'],"index=sfdc QUERY=* EVENT_TYPE=API OR EVENT_TYPE=BulkAPI OR EVENT_TYPE=RestAPI | rex field=QUERY max_match=12 ""\s(?i)from\s*(?<QUERY_TABLE>[\w_]*)"" | search QUERY_TABLE=Account* OR QUERY_TABLE=Contact* OR QUERY_TABLE=Opportunity* | lookup SFDC_User_Lookup USER_ID| stats earliest(_time) as earliest latest(_time) as latest  by USER_NAME, QUERY_TABLE | where earliest > relative_time(now(), ""-1d@d"") "
New User Taking Privileged Actions,Record when a user who hasn't taken privileged actions before suddenly starts.,"['Windows Security', 'Authentication']","Insider Threat, Privilege Escalation","Compliance, Insider Threat","['Privilege Escalation', 'Persistence']","['Valid Accounts', 'Create Account']",['Actions on Objectives'],"index=* tag=privileged| stats earliest(_time) as earliest latest(_time) as latest  by user, dest | where earliest > relative_time(now(), ""-1d@d"") "
Non-Privileged Users taking Privileged Actions,Detect users who shouldn't be able admins taking privileged actions.,"['Windows Security', 'Authentication']","Compliance, Insider Threat, Privilege Escalation","Compliance, Insider Threat",['Privilege Escalation'],['Valid Accounts'],['Actions on Objectives'],"index=* source=""*WinEventLog:Security"" tag=privileged| lookup PrivilegedRiskScores user OUTPUT isAdminAccount | search isAdminAccount=0 "
Old Passwords in Use,Detect active accounts with passwords that haven't been updated in more than 120 days.,['Windows Security'],"Compliance, GDPR",Compliance,['Credential Access'],['Brute Force'],[],"| ldapsearch search=""(&(objectclass=user)(!(objectClass=computer)))"" attrs=""sAMAccountName,pwdLastSet,lastLogonTimestamp,whenCreated,badPwdCount,logonCount"" | fields - _raw host _time | convert timeformat=""%Y-%m-%dT%H:%M:%S.%6QZ"" mktime(pwdLastSet) mktime(lastLogonTimestamp) | convert timeformat=""%Y%m%d%H%M%S.0Z""  mktime(whenCreated) | where pwdLastSet < relative_time(now(), ""-120d"") AND lastLogonTimestamp > relative_time(now(), ""-30d"") | convert ctime(lastLogonTimestamp) ctime(whenCreated) ctime(pwdLastSet)"
Open Redirect In Splunk Web,"This search allows you to look for evidence of exploitation for CVE-2016-4859, the Splunk Open Redirect Vulnerability.",['Any Splunk Logs'],Web Attack,Application Security,[],[],['Delivery'],
Outdated Malware Definitions,"Looks for Symantec AV systems where we see Symantec AV events, but don't see a malware definition update in the last few days.",['Anti-Virus or Anti-Malware'],"Operations, Compliance, Endpoint Compromise",Security Monitoring,[],[],[]," index=* sourcetype=symantec:* |stats max(eval(if(like(Event_Description, ""%LiveUpdate session ran successfully%"") , _time, null))) as LatestUpdate max(_time) as LatestMessage max(eval(if(tag=""error"", _time, null))) as LatestError by Host_Name | where LatestUpdate < relative_time(LatestMessage, ""-3d"") OR LatestError > LatestUpdate | convert ctime(LatestUpdate) ctime(LatestMessage) ctime(LatestError)"
Outdated Malware Definitions,"Looks for Symantec AV systems where we see Symantec AV events, but don't see a malware definition update in the last few days.",['Anti-Virus or Anti-Malware'],"Operations, Compliance, Endpoint Compromise",Security Monitoring,[],[],[]," index=* sourcetype=symantec:* |stats max(eval(if(like(Event_Description, ""%LiveUpdate session ran successfully%"") , _time, null))) as LatestUpdate max(_time) as LatestMessage max(eval(if(tag=""error"", _time, null))) as LatestError by Host_Name | where LatestUpdate < relative_time(LatestMessage, ""-3d"") OR LatestError > LatestUpdate | convert ctime(LatestUpdate) ctime(LatestMessage) ctime(LatestError)"
Personally Identifiable Information Detected,"Detects personally identifiable information (PII) in log files. Some software can inadvertently provide sensitive information in log files, resulting in potential exposure to those reviewing the log files.",['Any Splunk Logs'],"Compliance, Insider Threat, Data Exfiltration, GDPR","Compliance, Insider Threat",[],[],[],
Potential Day Trading,Detect users who exhibit a large amount of stock trading activity in their proxy logs.,['Web Proxy'],Insider Threat,Insider Threat,[],[],[],index=pan_logs category=financial-services earliest=-7d@d user!=unknown duration>60  |bucket _time span=1h | stats count max(duration) as maxduration by user _time | where count > 30 | stats count as num_hours_active sum(count) as total_connections median(count) as median_connections_per_hour max(maxduration) as max_duration_in_seconds by user  | where num_hours_active>20
Potential Gap in Data,Detects gaps caused by the failure of the search head. If saved searches do not execute then there may be gaps in summary data.,['Any Splunk Logs'],Operations,"Security Monitoring, Compliance",[],[],[],
Processes with High Entropy Names,Some malware will launch processes with randomized filenames.,"['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,['Defense Evasion'],['Obfuscated Files or Information'],['Installation'],"index=* source=""*WinEventLog:Security"" EventCode=4688 New_Process_Name=C:\\Users*| lookup ut_shannon_lookup word as New_Process_Name | where ut_shannon > 4.5 | stats  values(ut_shannon)  as ""Shannon Entropy Score"" by New_Process_Name,host | rename  New_Process_Name as Process,host as Endpoint | sort  -""Shannon Entropy Score"" "
Processes with Lookalike (typo) Filenames,"To evade analysts, attackers will create a service with a name similar to that of a standard Windows service. This search looks for small differences. Idea from David Bianco, formerly of Sqrrl (link).","['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,"['Defense Evasion', 'Execution']","['Masquerading', 'Service Execution']",['Installation'],"index=* (source=""*WinEventLog:Security"" EventCode=4688 ) OR (sourcetype=*sysmon* EventCode=1)| eval Image=coalesce(Image, New_Process_Name) | rex field=Image ""(?<filename>[^\\\\/]*$)"" | stats values(host) as hosts dc(host) as num_hosts values(Image) as Images by filename | eval levenshtein_scores=null | eval comparisonterm=""svchost.exe""  | lookup ut_levenshtein_lookup word1 as filename, word2 as comparisonterm | eval levenshtein_scores=mvappend(levenshtein_scores, ut_levenshtein) | eval score{ut_levenshtein} = comparisonterm | eval comparisonterm=""iexplore.exe"" | lookup ut_levenshtein_lookup word1 as filename, word2 as comparisonterm | eval levenshtein_scores=mvappend(levenshtein_scores, ut_levenshtein) | eval score{ut_levenshtein} = comparisonterm | eval comparisonterm=""ipconfig.exe"" | lookup ut_levenshtein_lookup word1 as filename, word2 as comparisonterm | eval levenshtein_scores=mvappend(levenshtein_scores, ut_levenshtein) | eval score{ut_levenshtein} = comparisonterm | eval comparisonterm=""explorer.exe"" | lookup ut_levenshtein_lookup word1 as filename, word2 as comparisonterm | eval levenshtein_scores=mvappend(levenshtein_scores, ut_levenshtein) | eval score{ut_levenshtein} = comparisonterm | eventstats max(num_hosts) as max_num_hosts | where isnull(mvfilter(levenshtein_scores=""0"")) AND min(levenshtein_scores) <3 | eval lowest_levenshtein_score=min(levenshtein_scores) | eval suspect_files = null | foreach score* [eval temp = ""<<FIELD>>"" | rex field=temp ""(?<num>\d*)$"" | eval suspect_files=if(num<3,mvappend('<<FIELD>>', suspect_files),suspect_files) | fields - temp ""<<FIELD>>""] | eval percentage_of_hosts_affected = round(100*num_hosts/max_num_hosts,2)| table filename lowest_levenshtein_score suspect_files Images hosts num_hosts percentage_of_hosts_affected"
Public Cloud Storage (Bucket),"Detects when new or existing public storage (e.g., an S3 Bucket) is set to public.","['Audit Trail', 'GCP', 'Azure', 'AWS']","Data Exfiltration, SaaS","Security Monitoring, Advanced Threat Detection",[],[],[],"index=* sourcetype=aws:cloudtrail AllUsers eventName=PutBucketAcl | spath output=userIdentityArn path=userIdentity.arn | spath output=bucketName path=""requestParameters.bucketName"" | spath output=aclControlList path=""requestParameters.AccessControlPolicy.AccessControlList"" | spath input=aclControlList output=grantee path=Grant{} | mvexpand grantee | spath input=grantee | search ""Grantee.URI""=*AllUsers | table _time, Permission, Grantee.URI, bucketName, userIdentityArn | sort - _time"
Pull List of Privileged Users,"To focus detection or response on privileged users, you must first build a list of accounts that have elevated rights or access to privileged information.",['Windows Security'],Insider Threat,Insider Threat,[],[],['Actions on Objectives'],"| ldapsearch search=""(&(objectclass=group)(|(cn=*Admins*)(cn=*Administrators*)))"" attrs=""cn,distinguishedName,groupType,member,memberOf"" | search groupType=SECURITY_ENABLED | stats count by member | eval member=""(distinguishedName="" . member . "")"" | eval length = len(member) | streamstats sum(length) as length | eval queryNum = round((length + 5000000) / 10000000, 0)| stats values(member) as search by queryNum| eval search=""(|"" . mvjoin(search, """") . "")"" | map maxsearch=100 search=""| ldapsearch search=\""$search$\"" attrs=\""sAMAccountName,title,displayName,sAMAccountName,mail,department,company,description\"""" | table description title displayName sAMAccountName mail department company | outputlookup users_who_are_members_of_admin_groups.csv"
RFC1918 IP Not in CMDB,Find internal addresses that aren't in your Asset database.,['Network Communication'],"Best Practices, Compliance, Shadow IT","Security Monitoring, Compliance",['Initial Access'],['Hardware Additions'],[],| tstats summariesonly=t allow_old_summaries=t count from datamodel=Network_Traffic where All_Traffic.src_ip=10.0.0.0/8 OR All_Traffic.src_ip=192.168.0.0/16 OR All_Traffic.src_ip=172.16.0.0./12 by All_Traffic.src_ip | lookup asset_lookup_by_str ip as All_Traffic.src_ip OUTPUT key | where isnull(key)
Ransomware Extensions,This example queries your endpoint data to find encrypted files that ransomware will create. You can often even use these extensions to identify the ransomware affecting a given endpoint.,"['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,['Execution'],['User Execution'],['Actions on Objectives'],"index=* sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=2 OR EventCode=11 | rex field=TargetFilename ""^\S+(?<extension>\.\S+)$"" | lookup ransomware_extensions_lookup Extensions AS extension | search Name!=false  | stats values(TargetFilename) AS ""Files Written"" by _time, host, Image, Name, extension"
Ransomware Note Files,Most ransomware leaves a note on the endpoint containing directions for the victim to pay a ransom. This use case looks for these note files.,"['Windows Security', 'Endpoint Detection and Response']",Endpoint Compromise,Advanced Threat Detection,['Execution'],['User Execution'],['Actions on Objectives'],"index=* sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=2 EventCode=11 [ | inputlookup ransomware_notes_lookup | rename ransomware_notes as TargetFilename | eval TargetFilename=""*"" . TargetFilename | table TargetFilename]| bucket _time span=1d | stats values(TargetFilename) as filesWritten by _time host Image"
Ransomware Vulnerabilities,This use case queries your Vulnerability Management logs from solutions like Nessus in order to identify the hosts in your environment that might be vulnerable to ransomware.,['Vulnerability Detection'],Vulnerability,"Security Monitoring, Compliance",[],[],['Actions on Objectives'],"index=* (sourcetype=nessus:scan OR tag=vulnerability) (cve = cve-2017-0143 OR cve = cve-2017-0144 OR cve = cve-2017-0145 OR cve = cve-2017-0146 OR cve = cve-2017-0147 OR cve = cve-2017-0148 OR cve = cve-2014-6332 OR cve = cve-2012-0158 OR cve = cve-2014-4114 OR cve = cve-2014-1761 OR cve = cve-2013-3906 OR cve = cve-2015-1641) | bucket _time span=1d | stats values(cve) as CVEs by _time, signature, netbios-name, hostname"
Recurring Infection on Host,Looks for the same malware occurring multiple times on the same host.,['Anti-Virus or Anti-Malware'],Endpoint Compromise,Security Monitoring,"['Initial Access', 'Execution']","['Drive-by Compromise', 'Spearphishing Link', 'Spearphishing Attachment', 'User Execution']",['Delivery'],"index=* sourcetype=symantec:* earliest=-30d | stats count range(_time) as TimeRange by Risk_Name, Computer_Name | where TimeRange>1800 | eval TimeRange_In_Hours = round(TimeRange/3600,2), TimeRange_In_Days = round(TimeRange/3600/24,2)"
Recurring Infection on Host,Looks for the same malware occurring multiple times on the same host.,['Anti-Virus or Anti-Malware'],Endpoint Compromise,Security Monitoring,"['Initial Access', 'Execution']","['Drive-by Compromise', 'Spearphishing Link', 'Spearphishing Attachment', 'User Execution']",['Delivery'],"index=* sourcetype=symantec:* earliest=-30d | stats count range(_time) as TimeRange by Risk_Name, Computer_Name | where TimeRange>1800 | eval TimeRange_In_Hours = round(TimeRange/3600,2), TimeRange_In_Days = round(TimeRange/3600/24,2)"
Registry Keys For Creating Shim Databases,"This search looks for registry activity associated with application compatibility shims, which can be leveraged by attackers for various nefarious purposes.",['Windows Security'],Endpoint Compromise,Advanced Threat Detection,"['Privilege Escalation', 'Persistence']",['Event Triggered Execution'],['Actions On Objectives'],
Registry Keys Used For Persistence,The search looks for modifications to registry keys that can be used to launch an application or service at system startup.,['Windows Security'],Endpoint Compromise,Advanced Threat Detection,"['Persistence', 'Privilege Escalation']",['Boot or Logon Autostart Execution'],['Actions On Objectives'],
Registry Keys Used For Privilege Escalation,"This search looks for modifications to registry keys that can be used to elevate privileges. The registry keys under ""Image File Execution Options"" are used to intercept calls to an executable and can be used to attach malicious binaries to benign system binaries.",['Windows Security'],Privilege Escalation,Advanced Threat Detection,"['Persistence', 'Privilege Escalation']",['Boot or Logon Autostart Execution'],['Actions On Objectives'],
Remote Desktop Network Bruteforce,This search looks for RDP application network traffic and filters any source/destination pair generating more than twice the standard deviation of the average traffic.,['Network Communication'],"Malware,",Security Monitoring,['Lateral Movement'],['Remote Services'],"['Reconnaissance', 'Delivery']",
Remote PowerShell Launches,It's unusual for new users to remotely launch PowerShell on another system. This will track the first time per user + host combination that powershel is remotely started.,"['Endpoint Detection and Response', 'Windows Security']",Lateral Movement,Advanced Threat Detection,['Lateral Movement'],['Remote Services'],['Installation'],"index=* source=""*WinEventLog:Security"" EventCode=4688 wsmprovhost svchost ParentImage=*\\svchost.exe Image=*\\wsmprovhost.exe | table _time user host EventCode New_Process_Name| stats earliest(_time) as earliest latest(_time) as latest  by user, dest | where earliest > relative_time(now(), ""-1d@d"") "
Risky Events from Privileged Users,"When something generally risky occurs to your most privileged users, you likely should respond more quickly. Fortunately, this is easy to do.",['Ticket Management'],"Insider Threat, IAM Analytics","Insider Threat, Security Monitoring","['Persistence', 'Privilege Escalation']",['Valid Accounts'],[],index=risk risk_object_type=user | lookup PrivilegedRiskScores user as risk_object | search risk_score>0
SMB Traffic Allowed,This use case looks for any SMB traffic allowed through your firewall.,['Network Communication'],"Operations, Ransomware",Security Monitoring,"['Execution', 'Lateral Movement']","['Exploitation of Remote Services', 'Windows Admin Shares', 'Service Execution']","['Reconnaissance', 'Delivery']",index=* ((tag=network tag=communicate) OR (sourcetype=pan*traffic OR sourcetype=opsec OR sourcetype=cisco:asa OR sourcetype=stream* )) action=allowed (app=smb OR dest_port=139 OR dest_port=445) | bucket _time span=1d | stats count by _time src_ip dest_ip dest_port
SMB Traffic Spike - MLTK,This search uses the Machine Learning Toolkit (MLTK) to identify spikes in the number of Server Message Block (SMB) connections.,['Network Communication'],"Malware,",Advanced Threat Detection,['Lateral Movement'],['Remote Services'],['Actions On Objectives'],
Short Lived Admin Accounts,"A technique used by attackers is to create an account, take some actions, and then delete it right away. This search will find those accounts on the local system.",['Windows Security'],Endpoint Compromise,Advanced Threat Detection,"['Defense Evasion', 'Persistence']","['Create Account', 'Defense Evasion']",['Command and Control'],"index=* source=""*WinEventLog:Security""   EventCode=4726 OR EventCode=4720 | eval Account_Name=mvindex(Account_Name,1) | transaction Account_Name maxspan=180m startswith=""EventCode=4726"" endswith=""EventCode=4720"" connected=false| table _time EventCode Account_Name Message"
Short Lived Windows Accounts,This search detects accounts that were created and deleted in a short time period.,['Windows Security'],Best Practices,Security Monitoring,['Persistence'],['Create Account'],[],
Significant Increase in Interactive Logons,Typically non-admin users will only interactively log into one system per day. A user who starts loggin into many can indicate account compromise and lateral movement. (MITRE CAR Reference),['Windows Security'],Lateral Movement,Advanced Threat Detection,"['Lateral Movement', 'Privilege Escalation', 'Persistence']","['Lateral Movement', 'Valid Accounts', 'Remote Services']","['Installation', 'Actions On Objectives']","index=* source=""*WinEventLog:Security"" Logon_Type=2 OR Logon_Type=10 OR Logon_Type=11 Logon Type TaskCategory=Logon Audit Success | bucket _time span=1d | stats dc(dest) as count by _time user| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by user | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'count' > upperBound AND num_data_samples >=7"
Significant Increase in Interactively Logged On Users,"Most systems will have a relatively predictable number of interactively logged on users. This search will look for systems that have dramatically more than they typically do, with a per-user baseline.",['Windows Security'],Endpoint Compromise,Advanced Threat Detection,"['Privilege Escalation', 'Persistence']",['Valid Accounts'],"['Command and Control', 'Installation']","index=* source=""*WinEventLog:Security"" Logon_Type=2 OR Logon_Type=10 OR Logon_Type=11 Logon Type TaskCategory=Logon Audit Success | bucket _time span=1d | stats dc(user) as count by _time dest| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by dest | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'count' > upperBound AND num_data_samples >=7"
Sources Sending Many DNS Requests,"A common method for Data Exfiltration is to send out many DNS or Ping requests, embedding data into the payload. This is often not logged.",['Network Communication'],"Data Exfiltration, Endpoint Compromise","Advanced Threat Detection, Insider Threat","['Exfiltration', 'Command and Control']","['Exfiltration Over C2 Channel', 'Commonly Used Port', 'Application Layer Protocol']","['Command and Control', 'Actions On Objectives']","((tag=network tag=communicate) OR (index=pan_logs sourcetype=pan*traffic) OR (index=* sourcetype=opsec) OR (index=* sourcetype=cisco:asa) ) dest_port=53 | bucket _time span=1h | stats count by src_ip _time | eventstats max(_time) as maxtime avg(count) as avg_count stdev(count) as stdev_count | eventstats count as num_data_samples avg(eval(if(_time < relative_time(maxtime, ""@h""),count,null))) as per_source_avg_count stdev(eval(if(_time < relative_time(maxtime, ""@h""),count,null))) as per_source_stdev_count by src_ip  | where num_data_samples >=4 AND count > avg_count + 3 * stdev_count AND count > per_source_avg_count + 3 * per_source_stdev_count AND _time >= relative_time(maxtime, ""@h"") | eval num_standard_deviations_away_from_org_average = round(abs(count - avg_count) / stdev_count,2), num_standard_deviations_away_from_per_source_average = round(abs(count - per_source_avg_count) / per_source_stdev_count,2) | fields - maxtime per_source* avg* stdev*"
Sources Sending a High Volume of DNS Traffic,"A common method of data exfiltration is to send out a huge volume (in bytes) of DNS or ping requests, embedding data into the payload. This is often not logged.",['Network Communication'],Data Exfiltration,Insider Threat,"['Exfiltration', 'Command and Control']","['Exfiltration Over Alternative Protocol', 'Application Layer Protocol', 'Exfiltration Over C2 Channel']","['Command and Control', 'Actions On Objectives']","(tag=network tag=communicate) OR (index=pan_logs sourcetype=pan*traffic) OR (index=* sourcetype=opsec) OR (index=* sourcetype=cisco:asa)  | bucket _time span=1h | stats sum(bytes*) as bytes* by src_ip _time | eventstats max(_time) as maxtime avg(bytes_out) as avg_bytes_out stdev(bytes_out) as stdev_bytes_out | eventstats count as num_data_samples avg(eval(if(_time < relative_time(maxtime, ""@h""),bytes_out,null))) as per_source_avg_bytes_out stdev(eval(if(_time < relative_time(maxtime, ""@h""),bytes_out,null))) as per_source_stdev_bytes_out by src_ip  | where num_data_samples >=4 AND bytes_out > avg_bytes_out + 3 * stdev_bytes_out AND bytes_out > per_source_avg_bytes_out + 3 * per_source_stdev_bytes_out AND _time >= relative_time(maxtime, ""@h"") | eval num_standard_deviations_away_from_org_average = round(abs(bytes_out - avg_bytes_out) / stdev_bytes_out,2), num_standard_deviations_away_from_per_source_average = round(abs(bytes_out - per_source_avg_bytes_out) / per_source_stdev_bytes_out,2) | fields - maxtime per_source* avg* stdev*"
Spike in Downloaded Documents Per User from Salesforce.com,"Salesforce.com contains the most critical information for many companies. This example tracks the number of documents downloaded per day per user, to detect exfiltration.",['Audit Trail'],"Data Exfiltration, SaaS",Insider Threat,['Collection'],['Data from Information Repositories'],['Actions on Objectives'],"index=sfdc EVENT_TYPE=DocumentAttachmentDownloads | lookup SFDC_User_Lookup USER_ID | bucket _time span=1d | stats count by USER_NAME _time| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by USER_NAME | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'count' > upperBound AND num_data_samples >=7"
Spike in Exported Records from Salesforce.com,"For many organizations, Salesforce.com contains the most critical information in their company. This use case tracks the number of records exported per day (and is based on a real set of data collection).",['Audit Trail'],"Data Exfiltration, GDPR, SaaS","Compliance, Insider Threat",['Collection'],['Data from Information Repositories'],['Actions on Objectives'],"index=sfdc ROWS_PROCESSED>0 EVENT_TYPE=API OR EVENT_TYPE=BulkAPI OR EVENT_TYPE=RestAPI| lookup SFDC_User_Lookup USER_ID| bucket _time span=1d | stats sum(ROWS_PROCESSED) as rows by _time USER_NAME| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'rows',null))) as rows avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'rows',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'rows',null))) as stdev by USER_NAME | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'rows' > upperBound AND num_data_samples >=7"
Spike in Password Reset Emails,Sending password reset emails is a common phishing technique. Protect your users by identifying spikes in the number of suspicious emails entering your environment.,['Email'],"Account Compromise, SaaS",Security Monitoring,['Initial Access'],['Spearphishing Link'],['Delivery'],"index=* sourcetype=cisco:esa* OR sourcetype=ms:o365:*:messagetrace OR sourcetype=MSExchange*:MessageTracking OR tag=email Password Reset | eval Detect_Type=case(LIKE(Subject, ""%Password Reset%""), ""Password Reset"", LIKE(Subject, ""%Validate Credentials%""), ""Validate Credentials"",1=1, null) | bucket _time span=1d | stats count by _time Detect_Type | stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by Detect_Type | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'count' > upperBound AND num_data_samples >=7"
Spike in SMB Traffic,This search looks for hosts with an unusually high increase in SMB network connections.,['Network Communication'],"Lateral Movement, Scanning, Ransomware","Advanced Threat Detection, Security Monitoring","['Discovery', 'Lateral Movement']","['Network Share Discovery', 'Ingress Tool Transfer', 'Remote Services']",['Actions On Objectives'],"index=* ((tag=network tag=communicate) OR (sourcetype=pan*traffic OR sourcetype=opsec OR sourcetype=cisco:asa OR sourcetype=stream* )) (dest_port=139 OR dest_port=445) | bucket _time span=1d | stats dc(dest_ip) as count by src_ip, _time | stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by src_ip | eval lowerBound=(avg-stdev*undefined), upperBound=(avg+stdev*undefined)| where 'count' > upperBound AND num_data_samples >=7"
Stale Account Usage,Detect long-inactive accounts that suddenly become active.,"['Windows Security', 'Authentication']","Insider Threat, IAM Analytics, Account Compromise","Insider Threat, Security Monitoring","['Privilege Escalation', 'Persistence', 'Initial Access']",['Valid Accounts'],['Actions on Objectives'],"index=* source=""*WinEventLog:Security"" action=success | stats count min(_time) as earliest max(_time) as latest by user | multireport     [| stats values(*) as * by user     | lookup account_status_tracker user OUTPUT count as prior_count earliest as prior_earliest latest as prior_latest     | where prior_latest < relative_time(now(), ""-90d"")     | eval explanation=""The last login from this user was "" . (round( (earliest-prior_latest) / 3600/24, 2) ) . "" days ago.""     | convert ctime(earliest) ctime(latest) ctime(prior_earliest) ctime(prior_latest) ]     [| inputlookup append=t account_status_tracker     | stats min(earliest) as earliest max(latest) as latest sum(count) as count by user     | outputlookup account_status_tracker     | where this_only_exists_to_update_the_lookup='so we will make sure there are no results'] "
Successful Login of Account for Former Employee,You shouldn't see any successful authentication activity on the accounts of former employees. Track this easily in Splunk.,"['Windows Security', 'Authentication']","Account Compromise, Insider Threat","Security Monitoring, Insider Threat","['Privilege Escalation', 'Credential Access']","['Valid Accounts', 'Account Manipulation']",['Actions on Objectives'],"index=* (source=""*WinEventLog:Security"" OR sourcetype=linux_secure OR tag=authentication) user=* user!="""" action=success | lookup user_account_status.csv user | where _time > relative_time(terminationDate, ""+1d"")"
Unauthorized Connection Through Firewall,"Any communication through the firewall not explicitly granted by policy could indicate either a misconfiguration or even malicious actions, putting your security and compliance at risk.",['Network Communication'],"GDPR, Data Exfiltration, Scanning","Security Monitoring, Compliance","['Exfiltration', 'Discovery', 'Command and Control']","['Exfiltration Over C2 Channel', 'Exfiltration Over Alternative Protocol', 'Custom Command and Control Protocol', 'Standard Cryptographic Protocol', 'Non-Application Layer Protocol', 'Network Service Scanning']",['Command and Control'],"index=pan_logs sourcetype=pan*traffic rule=""*-default"" action=allowed | lookup gdpr_system_category.csv host as src_ip | search category=*"
Unauthorized Connection Through Firewall,"Any communication through the firewall not explicitly granted by policy could indicate either a misconfiguration or even malicious actions, putting your security and compliance at risk.",['Network Communication'],"GDPR, Data Exfiltration, Scanning","Security Monitoring, Compliance","['Exfiltration', 'Discovery', 'Command and Control']","['Exfiltration Over C2 Channel', 'Exfiltration Over Alternative Protocol', 'Custom Command and Control Protocol', 'Standard Cryptographic Protocol', 'Non-Application Layer Protocol', 'Network Service Scanning']",['Command and Control'],"index=pan_logs sourcetype=pan*traffic rule=""*-default"" action=allowed | lookup gdpr_system_category.csv host as src_ip | search category=*"
Unsuccessful Netbackup Backups,This search gives you the hosts where a backup was attempted and then failed.,['Backup'],Compliance,Compliance,[],[],[],
Unusual Child Process for spoolsv.exe or connhost.exe,"In late August 2018, a new Windows Zero Day was announced via Twitter, and the only apparent defense is to detect unusual child processes from spoolsv.exe or connhost.exe. SSE already detected the POC, but this specifically looks for any potential detection.",['Endpoint Detection and Response'],Endpoint Compromise,Advanced Threat Detection,['Privilege Escalation'],['Exploitation for Privilege Escalation'],['Exploitation'],"index=* sourcetype=*sysmon* EventCode=1 (spoolsv.exe Image=*\spoolsv.exe) OR (connhost.exe Image=*\connhost.exe)  |table  _time host Image ProcessId ParentImage ParentProcessId sha1| stats earliest(_time) as earliest latest(_time) as latest  by Image, ParentImage | where earliest > relative_time(now(), ""-1d@d"") "
Unusual Cloud Regions,Looks for activity in IaaS Regions that have not been used before across the organization.,"['Audit Trail', 'GCP', 'Azure', 'AWS']","Account Compromise, SaaS",Advanced Threat Detection,"['Persistence', 'Privilege Escalation']",['Valid Accounts'],['Actions on Objectives'],"index=* sourcetype=aws:cloudtrail| stats earliest(_time) as earliest latest(_time) as latest  by awsRegion, sourcetype | where earliest > relative_time(now(), ""-1d@d"") "
Unusual Number of Modifications to Cloud ACLs,Looks for a large number of Security Group ACL changes in a short period of time for a user.,"['Audit Trail', 'GCP', 'Azure', 'AWS']","Account Compromise, IAM Analytics, Data Exfiltration, Network Attack, SaaS",Advanced Threat Detection,"['Persistence', 'Privilege Escalation']",['Valid Accounts'],['Actions on Objectives'],"index=* sourcetype=aws:cloudtrail eventName=AuthorizeSecurityGroup* | bucket _time span=1d | stats count by user _time| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by user | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'count' > upperBound AND num_data_samples >=7"
Unusually Long Content-Type Length,This search looks for unusually long strings in the Content-Type http header that the client sends the server.,['Web Server'],Web Attack,Application Security,[],[],['Delivery'],
User Finding Project Code Names from Many Departments,Find users trying to collect and analyze internal projects from across multiple departments by analyzing their search logs on company wiki software.,['Web Server'],Insider Threat,Insider Threat,['Collection'],['Data from Information Repositories'],['Actions on Objectives'],"index=* source=""/opt/confluence/*/access_log*"" dosearchsite | eval queryString=urldecode(queryString) | rex field=queryString max_match=10 [| inputlookup sse_project_codenames | stats values(codeword) as search | eval search=mvjoin(search, ""|"") | eval search=""\""(?<codeword_matched>"" . search . "")\""""]  | lookup sse_project_codenames codeword as codeword_matched | bucket _time span=1d | stats dc(department) as count by user, _time | where count >= 5"
User Has Access to In-Scope Splunk Indexes They Should Not,Alerts the first time a user gains rights to search an index that they're not supposed to according to the output of a GDPR data source and GDPR user mapping exercise.,['Any Splunk Logs'],"GDPR, IAM Analytics, Operations","Insider Threat, Compliance",[],[],['Actions on Objectives'],"| `User_to_Index_Provisioning_From_Data_Governance_App`| lookup gdpr_splunk_index_category index as accessible_indexes OUTPUT category as index_category | search index_category=* | lookup gdpr_user_category user OUTPUT category as user_category| makemv delim=""|"" index_category | makemv delim=""|"" user_category | where isnull(user_category) OR user_category != index_category "
User Logged into In-Scope System They Should Not Have,"Follow your GDPR requirement and action your data mapping exercise by tracking employee/vendor/supplier access to systems, to ensure that they are authorized to view the data present on any systems they log into.","['Windows Security', 'Authentication']","GDPR, IAM Analytics, Lateral Movement, Operations","Insider Threat, Compliance","['Credential Access', 'Privilege Escalation', 'Collection']","['Valid Accounts', 'Data from Information Repositories', 'Account Manipulation']",['Actions on Objectives'],"index=* source=""*WinEventLog:Security"" user=* dest=* action=success | bucket _time span=1d | stats count by user, dest | lookup gdpr_system_category.csv host as dest OUTPUT category as dest_category | search dest_category=* | lookup gdpr_user_category user OUTPUT category as user_category| makemv delim=""|"" dest_category | makemv delim=""|"" user_category | where isnull(user_category) OR user_category != dest_category"
User Login to Unauthorized Geo,"For regulated environments, detect users logging into servers where they're not permitted.","['Authentication', 'AWS', 'Audit Trail']",Compliance,Compliance,['Initial Access'],['Valid Accounts'],['Actions on Objectives'],"index=* source=""*WinEventLog:Security"" action=success | lookup sse_host_to_country dest OUTPUT country as server_country | lookup gdpr_user_category user OUTPUT countries as authorized_countries | makemv authorized_countries delim=""|"" | where authorized_countries!=server_country AND server_country IN (""Germany"",""Japan"") | eval authorized_countries=mvjoin(authorized_countries, "", "") | stats dc(anonymized_ComputerName) as num_servers count as num_logins by user authorized_countries server_country"
User Login with Local Credentials,"Categorically, most interactive logins should use domain credentials. Detect when a new user logs on with local credentials that bypass most centralized logging and policy systems, but not Splunk!",['Windows Security'],"Insider Threat, Privilege Escalation, Endpoint Compromise, Account Compromise","Insider Threat, Security Monitoring","['Privilege Escalation', 'Initial Access', 'Credential Access']","['Valid Accounts', 'Account Manipulation']",[],"index=* source=""*WinEventLog:Security"" tag=authentication action=success Logon_Type=2 OR Logon_Type=10 OR Logon_Type=11 Logon Type NOT (Account_Domain=""NT Authority"" OR Account_Domain=""MYDOMAIN"" OR Account_Domain=""SUBSIDIARY*"" OR Account_Domain=""YourDomainsHere"" OR Account_Name=""*$"")| eval  Account_Domain=mvfilter(Account_Domain!=""-"")| table _time user Account_Domain, Authentication_Package, EventCode, Key_Length, Logon_Process, Logon_Type, Security_ID, Type"
User with Increase in Outgoing Email,"Both to detect data exfiltration and compromised account, we can analyze users that are sending out dramatically more data than normal. This search looks per source email address for big increases in volume.",['Email'],"Data Exfiltration, Endpoint Compromise, SaaS","Advanced Threat Detection, Insider Threat",['Exfiltration'],['Exfiltration Over Alternative Protocol'],['Actions on Objectives'],"index=* sourcetype=cisco:esa* OR sourcetype=ms:o365:*:messagetrace OR sourcetype=MSExchange*:MessageTracking OR tag=email src_user=*| bucket _time span=1d | stats count by src_user, _time| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by sender | eval lowerBound=(avg-stdev*2), upperBound=(avg+stdev*2)| where 'count' > upperBound AND num_data_samples >=7"
User with Many DLP Events,Detect users that have many DLP events in a short period of time.,['DLP'],Insider Threat,Insider Threat,['Exfiltration'],['Exfiltration'],['Actions on Objectives'],"index=* tag=dlp tag=incident | bucket _time span=1d | stats count by user| stats count as num_data_samples max(eval(if(_time >= relative_time(maxtime, ""-1d@d""), 'count',null))) as count avg(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as avg stdev(eval(if(_time<relative_time(maxtime,""-1d@d""),'count',null))) as stdev by user | eval lowerBound=(avg-stdev*5), upperBound=(avg+stdev*5)| where 'count' > upperBound AND num_data_samples >=7"
WMI Permanent Event Subscription,This search looks for the creation of WMI permanent event subscriptions.,['Windows Security'],"Adversary Tactics,",Advanced Threat Detection,['Execution'],['Windows Management Instrumentation'],['Actions On Objectives'],
WMI Temporary Event Subscription,This search looks for the creation of WMI temporary event subscriptions.,['Windows Security'],"Adversary Tactics,",Advanced Threat Detection,['Execution'],['Windows Management Instrumentation'],['Actions On Objectives'],
Web Browsing to Unauthorized Sites,Detect users who are persistently attempting to violate your proxy policy.,['Web Proxy'],Insider Threat,Insider Threat,"['Exfiltration', 'Command and Control']","['Exfiltration Over Alternative Protocol', 'Application Layer Protocol', 'Web Service']",['Actions On Objectives'],((index=* sourcetype=pan*threat) OR tag=web) action=blocked user!=unknown app!=not-applicable  | stats count values(app) as apps values(category) as categories by user | where count>=30
Web Fraud - Account Harvesting,This search is used to identify the creation of multiple user accounts using the same email domain name.,['Web Server'],"Abuse,",Other,['Persistence'],['Create Account'],['Actions On Objectives'],
Web Fraud - Anomalous User Clickspeed,"This search is used to examine web sessions to identify those where the clicks are occurring too quickly for a human or are occurring with a near-perfect cadence (high periodicity or low standard deviation), resembling a script driven session.",['Web Server'],"Abuse,",Other,"['Defense Evasion', 'Persistence', 'Privilege Escalation', 'Initial Access']",['Valid Accounts'],['Actions On Objectives'],
Web Fraud - Password Sharing Across Accounts,This search is used to identify user accounts that share a common password.,['Web Server'],"Abuse,",Other,[],[],[],
Windows Event Log Cleared,This search looks for Windows events that indicate one of the Windows event logs has been purged.,['Windows Security'],Endpoint Compromise,Advanced Threat Detection,['Defense Evasion'],['Indicator Removal on Host'],['Actions On Objectives'],
Windows Event Log Clearing Events,This use case looks for Windows event codes that indicate the Windows Audit Logs were tampered with.,['Windows Security'],"Endpoint Compromise, Ransomware",Advanced Threat Detection,['Defense Evasion'],['Indicator Removal on Host'],['Actions On Objectives'],"index=* (source=""*WinEventLog:Security"" AND (EventCode=1102 OR EventCode=1100)) OR ((source=""*WinEventLog:System"") AND EventCode=104) | stats count by _time EventCode sourcetype host"
